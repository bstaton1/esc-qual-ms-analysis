---
title: "`r paste('Detailed Output for Model', model, sep = ': ')`"
subtitle: "Kuskokwim River Age/Sex-Structured BSS-SRA"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = "center")

library(postpack)
library(StatonMisc)
library(magrittr)
library(knitr)
library(kableExtra)
library(stringr)

# compile the data
data_dir = "../2-model-fit/inputs"
source("../2-model-fit/1-compile-data.R")

# load in additional functions
source("../new-func-source.R")

# location of output files
out_dir = "../../model-output-no-rand-age"

# names of output files
post_name = paste("post-", model, ".rds", sep = "")
meta_name = paste("meta-", model, ".rds", sep = "")
msy_name = paste("msy-", model, ".rds", sep = "")

# read in the saved output samples
post = readRDS(file.path(out_dir, post_name))
meta = readRDS(file.path(out_dir, meta_name))
msy = paste(file.path(out_dir, msy_name))
```

```{r settings}
mcmc_info = F
pp_check = F
jags_code = F
jags_data = F

```{r cntr}
# set up a counter
cntr = c(
  Model = model,
  Section = 0,
  Figure = 0,
  Table = 0
)

# function to increment the counter
up_cntr = function(type, cntr, eval = T) {
  if (eval) {
    cntr[type] = cntr[type] + 1
  }
  return(cntr)
}

# function to print a header
create_label = function(type, cntr, inc_type = T, level, sub = "", subb = "", text = "", tabset = F, eval = T) {
  type_text = paste0(type, ". ")
  id = paste0(
    "**", 
    ifelse(inc_type & type != "Section", type_text, ""),
    cntr[type], 
    ifelse(nchar(sub) > 0, "(", ""), 
    sub, subb,
    ifelse(nchar(sub) > 0, ")", ""), 
    "**"
    )
  hash = paste(rep("#", level), collapse = "")
  tabset_text = " {.tabset .tabset-fade .tabset-pills}"
  
  if (eval) paste0(hash, " ", id, " ", text, ifelse(tabset, tabset_text, ""))
}
```

# Model Description

```{r model-description-table}
pretty_z_unit = paste(capitalize(str_split(z_unit, "_")[[1]]), collapse = " ")

tab = data.frame(
  q = c(
    "Model Number",
    "Units of Reproductive Potential",
    "Length-at-age",
    "Sex-at-return",
    "Age-at-return",
    "Dirichlet age-at-return"
  ),
  v = c(meta$model, pretty_z_unit,
        ifelse(c(meta$len_trend, meta$sex_trend, meta$age_trend, meta$rand_age), "Yes", "No"))
)

colnames(tab) = c("Option", "Setting")

kable(tab, caption = "Assumptions regarding trends and reproductive units in this model.") %>%
  kable_styling(full_width = F) %>%
  group_rows("Trends", 3, 5, italic = T, bold = F)
```

`r if (mcmc_info) "# MCMC {.tabset .tabset-fade .tabset-pills}"`

`r if (mcmc_info) "## Dimensions"`

```{r mcmc-dimesion-info, eval = mcmc_info}
n_burn = unname(meta$mcmc.info["n.burnin"])
n_chain = unname(meta$mcmc.info["n.chains"])
n_post = unname(meta$mcmc.info["n.iter"]) - n_burn
n_thin = unname(meta$mcmc.info["n.thin"])
n_adapt = mean(unname(meta$mcmc.info[stringr::str_detect(names(meta$mcmc.info), "adapt")]))
n_save = n_post/n_thin * n_chain
n_total = (n_adapt + n_burn + n_post) * n_chain
tab = data.frame(
  q = c(
    "Adapt",
    "Burn-in",
    "Post-Burn-in",
    "Thinning Interval",
    "Chains",
    "Total Iterations",
    "Saved Iterations"
  ),
  v = prettify(c(n_adapt, n_burn, n_post, n_thin, n_chain, n_total, n_save))
)

colnames(tab) = c("Option", "Setting")

kable(tab, caption = "The MCMC settings used in this run.") %>%
  kable_styling(full_width = F) %>%
  group_rows("Per Chain", 1, 4) %>%
  row_spec(row = 7, bold = T)
```

`r if (mcmc_info) "## Run Time"`

```{r model-runtime-info, eval = mcmc_info}
elapse = meta$elapsed
elapse = str_split(elapse, " ")[[1]]
elapse = paste(round(abs(as.numeric(elapse[1])), 3), capitalize(elapse[2]), sep = " ")

tab = t(data.frame(Started = meta$starttime, Stopped = meta$stoptime, Elapsed = elapse))

kable(tab,caption = "Model run time information.") %>%
  kable_styling(full_width = F, position = "center") %>%
  row_spec(3, bold = T)
  
```

```{r model-fit-info, eval = F}
## Deviance Statistics
tab = data.frame(
  deviance = post_summ(post, "deviance")["mean",],
  pD = meta$pD, DIC = meta$DIC)
kable(round(tab), caption = "Model fit statistics.", row.names = F) %>%
  kable_styling(full_width = F)
```

`r if (mcmc_info) "## Diagnostics {.tabset .tabset-fade .tabset-pills}"`

`r if (mcmc_info) "### Rhat"`

```{r Rhat-info, eval = mcmc_info}
Rhat = meta$R.hat
params = rownames(Rhat)
params = paste("`", params, "`", sep = "")
rownames(Rhat) = NULL
Rhat = apply(Rhat, 2, function(x) round(x, 2))
Rhat = cbind(Parameter = params, Rhat)

kable(
  Rhat, 
  caption = "Summaries of the Rhat convergence diagnostic for key parameters/states across years, where applicable.", escape = F, row.names = F) %>%
  kable_styling(full_width = F)
```

`r if (mcmc_info) "### Effective Samples"`

```{r ess-info, eval = mcmc_info}
ess = meta$n.eff
params = rownames(ess)
params = paste("`", params, "`", sep = "")
rownames(ess) = NULL
ess = apply(ess, 2, function(x) prettify(round(x)))
ess = cbind(Parameter = params, ess)

kable(
  ess, 
  caption = "Summaries of the MCMC effective sample size diagnostic for key parameters/states across years, where applicable.", escape = F, row.names = F) %>%
  kable_styling(full_width = F)
```

`r if (mcmc_info) "### Sampling Behavior {.tabset .tabset-fade .tabset-pills}"`

`r if (mcmc_info) "#### D_sum"`

```{r D-sum-diag-plot, eval = mcmc_info}
par(oma = c(0,0,2,0))
diag_plots(post, "D_sum")
```

`r if (mcmc_info) "#### alpha"`

```{r alpha-diag-plot, eval = mcmc_info}
par(oma = c(0,0,2,0))
diag_plots(post, "alpha")
```

`r if (mcmc_info) "#### beta"`

```{r beta-diag-plot, eval = mcmc_info}
par(oma = c(0,0,2,0))
diag_plots(post, "beta$")
```

`r if (mcmc_info) "#### Selectivity Parameters"`

```{r V-params-diag-plots, eval = mcmc_info, fig.height = 7}
diag_plots(post, c("^Vtau$", "^Vsig$", "^Vtha$", "^Vlam$"))
```

`r if (mcmc_info) "#### Fishing Mortality {.tabset .tabset-fade .tabset-pills}"`

`r if (mcmc_info) "##### Commercial"`

```{r Fcom-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, c("Fcom"))
```

`r if (mcmc_info) "##### Subsistence"`

```{r Fsub-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, c("Fsub"))
```

`r if (mcmc_info) "#### Recruitment"`

```{r R-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, c("^R["))
```

# Fit to Data 

In all figures, the black points represent observed information, black lines represent the posterior median, and grey regions represent 95% equal-tailed credible intervals.

## Composition {.tabset .tabset-fade .tabset-pills}

### Figures {.tabset .tabset-fade .tabset-pills}

#### By Age/Sex {.tabset .tabset-fade .tabset-pills}

##### Escapement

```{r esc-age-sex-fit, fig.height = 8, fig.width = 6}
q_fit = array_format(post_summ(post, "q_esc")[3,])
q_lwr = array_format(post_summ(post, "q_esc")[4,])
q_upr = array_format(post_summ(post, "q_esc")[5,])
q_obs = t(apply(x_esc, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
}

```

##### Commercial

_Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh._

```{r com-age-sex-fit, fig.height = 8, fig.width = 6}
q_fit = array_format(post_summ(post, "q_com")[3,])
q_lwr = array_format(post_summ(post, "q_com")[4,])
q_upr = array_format(post_summ(post, "q_com")[5,])
q_obs = t(apply(x_com, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
  abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)
}
```

##### Subsistence

_Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh._

```{r sub-age-sex-fit, fig.height = 8, fig.width = 6}
q_fit = array_format(post_summ(post, "q_sub")[3,])
q_lwr = array_format(post_summ(post, "q_sub")[4,])
q_upr = array_format(post_summ(post, "q_sub")[5,])
q_obs = t(apply(x_sub, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
  abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
}
```

#### By Sex {.tabset .tabset-fade .tabset-pills}

Although the model fits to sex data on an age-specific basis by data source, we can still look at how well it captures patterns in sex composition.

##### Escapement

```{r esc-sex-fit}
pf_fit_esc = rowSums(array_format(post_summ(post, "q_esc")[3,])[,1:4])
pf_lwr_esc = rowSums(array_format(post_summ(post, "q_esc")[4,])[,1:4])
pf_upr_esc = rowSums(array_format(post_summ(post, "q_esc")[5,])[,1:4])
pf_esc = rowSums(x_esc[,1:4])/rowSums(x_esc)
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(pf_fit_esc ~ years, type = "l", ylim = c(0,1), las = 1, ylab = "Proportion Females", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(pf_lwr_esc, rev(pf_upr_esc)), col = "grey80", border = NA)
lines(pf_fit_esc ~ years, lwd = 2)
lines(pf_lwr_esc ~ years, col = "grey")
lines(pf_upr_esc ~ years, col = "grey")
points(pf_esc ~ years, pch = 16, cex = 1.2)
```

##### Commercial

_Vertical dashed line represents the year the fishery switched from unrestricted mesh to restricted mesh._

```{r com-sex-fit}
pf_fit_com = rowSums(array_format(post_summ(post, "q_com")[3,])[,1:4])
pf_lwr_com = rowSums(array_format(post_summ(post, "q_com")[4,])[,1:4])
pf_upr_com = rowSums(array_format(post_summ(post, "q_com")[5,])[,1:4])
pf_com = rowSums(x_com[,1:4])/rowSums(x_com)
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(pf_fit_com ~ years, type = "l", ylim = c(0,1), las = 1, main = "", ylab = "Proportion Females", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(pf_lwr_com, rev(pf_upr_com)), col = "grey80", border = NA)
lines(pf_fit_com ~ years, lwd = 2)
lines(pf_lwr_com ~ years, col = "grey")
lines(pf_upr_com ~ years, col = "grey")
points(pf_com ~ years, pch = 16, cex = 1.2)
abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)
```

##### Subsistence

_Vertical dashed line represents the year the fishery switched from unrestricted mesh to restricted mesh._

```{r sub-sex-fit}
pf_fit_sub = rowSums(array_format(post_summ(post, "q_sub")[3,])[,1:4])
pf_lwr_sub = rowSums(array_format(post_summ(post, "q_sub")[4,])[,1:4])
pf_upr_sub = rowSums(array_format(post_summ(post, "q_sub")[5,])[,1:4])
pf_sub = rowSums(x_sub[,1:4])/rowSums(x_sub)
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(pf_fit_sub ~ years, type = "l", ylim = c(0,1), las = 1, main = "", ylab = "Proportion Females", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(pf_lwr_sub, rev(pf_upr_sub)), col = "grey80", border = NA)
lines(pf_fit_sub ~ years, lwd = 2)
lines(pf_lwr_sub ~ years, col = "grey")
lines(pf_upr_sub ~ years, col = "grey")
points(pf_sub ~ years, pch = 16, cex = 1.2)
abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
```

#### Multinomial Effective Sample Size  {.tabset .tabset-fade .tabset-pills}

The multinomial effective sample size for each data set was rescaled such that the year with the most fish sampled for a given data set received an effective sample size of 100. All other years were scaled proportionately to that value, e.g., `ESS = n_aged_year/max(n_aged_year) * 100`

##### Escapement

```{r esc-ess}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_esc, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

##### Commercial

```{r com-ess}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_com, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

##### Subsistence

```{r sub-ess}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_sub, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

### Tables {.tabset .tabset-fade .tabset-pills}

The following tables show goodness-of-fit statistics for each data set.

```{r}
make_gof_table = function(by) {
  q_esc = array_format(post_summ(post, "q_esc")["mean",])
  q_com = array_format(post_summ(post, "q_com")["mean",])
  q_sub = array_format(post_summ(post, "q_sub")["mean",])
  
  esc_tot = ceiling(calc_mult_gof(x_esc, q_esc, per_n = F, by = by))
  com_tot = ceiling(calc_mult_gof(x_com, q_com, per_n = F, by = by))
  sub_tot = ceiling(calc_mult_gof(x_sub, q_sub, per_n = F, by = by))
  all_tot = ceiling(calc_mult_gof(rbind(x_esc, x_com, x_sub), rbind(q_esc, q_com, q_sub), per_n = F, by = by))
  esc_per = round(calc_mult_gof(x_esc, q_esc, per_n = T, by = by),2)
  com_per = round(calc_mult_gof(x_com, q_com, per_n = T, by = by),2)
  sub_per = round(calc_mult_gof(x_sub, q_sub, per_n = T, by = by),2)
  all_per = round(calc_mult_gof(rbind(x_esc, x_com, x_sub), rbind(q_esc, q_com, q_sub), per_n = T, by = by), 2)
  
  esc_fit = paste0(esc_tot, " (", esc_per, ")")
  com_fit = paste0(com_tot, " (", com_per, ")")
  sub_fit = paste0(sub_tot, " (", sub_per, ")")
  all_fit = paste0(all_tot, " (", all_per, ")")
  
  tab = rbind(esc_fit, com_fit, sub_fit, all_fit)
  tab = cbind(c("Escapement", "Commercial", "Subsistence", "Overall"), tab)
  rownames(tab) = NULL
  "Source"
  if (by == "sex") {
    colnames(tab) = c("Source", "Females", "Males")
    g_fun = function(x) {
      x %>%
        add_header_above(c(" " = 1, "Sex" = 2))
    }
  }
  if (by == "age/sex") {
    colnames(tab) = c("Source", paste(paste("Age", 4:7)), paste(paste("Age", 4:7)))
    g_fun = function(x) {
      x %>%
        add_header_above(c(" " = 1, "Females" = 4, "Males" = 4))
    }
  }
  if (by == "age") {
    colnames(tab) = c("Source", paste("", 4:7))
    g_fun = function(x) {
      x %>%
        add_header_above(c(" " = 1, "Age" = 4))
    }
  }
  if (by == "total") {
    colnames(tab) = c("Source", "Total")
    g_fun = function(x) {
      x
    }
  }
  
  kable(tab, "html", align = paste0("l", paste0(rep("c", ncol(tab) - 1), collapse = ""), collapse = "")) %>%
    kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
    column_spec(1, bold = T) %>%
    row_spec(4, bold = T) %>%
    g_fun()
}
```

#### Total

```{r}
make_gof_table("total")
```

#### By Sex

```{r}
make_gof_table("sex")
```

#### By Age

```{r}
make_gof_table("age")
```

#### By Age/Sex

```{r}
make_gof_table("age/sex")
```

## Abundance States {.tabset .tabset-fade .tabset-pills}

### Escapement

```{r esc-fit}
S_fit = post_summ(post, "^S_t[")/1000
mean_S_cv = paste0(round(mean(sig2cv(S_obs_sig)), 2) * 100, "%")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(S_fit[3,] ~ years, type = "n", ylim = range(0,S_fit[4:5,]), las = 1,
     main = paste0("Mean Observation CV: ", mean_S_cv), ylab = "Total Fish (1000s)", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(S_fit[4,], rev(S_fit[5,])), col = "grey80", border = NA)
lines(S_fit[4,] ~ years, col = "grey")
lines(S_fit[5,] ~ years, col = "grey")
lines(S_fit[3,] ~ years, lwd = 2)
points(I(S_obs/1000) ~ years, pch = 16, cex = 1.2)
```

### Commercial

```{r}
Hcom_fit = post_summ(post, "Hcom")/1000
mean_com_cv = paste0(round(mean(sig2cv(Hcom_obs_sig)), 2) * 100, "%")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(Hcom_fit[3,] ~ years, type = "n", ylim = range(0,Hcom_fit[4:5,]), las = 1, 
     main = paste0("Mean Observation CV: ", mean_com_cv), ylab = "Total Fish (1000s)", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Hcom_fit[4,], rev(Hcom_fit[5,])), col = "grey80", border = NA)
lines(Hcom_fit[4,] ~ years, col = "grey")
lines(Hcom_fit[5,] ~ years, col = "grey")
lines(Hcom_fit[3,] ~ years, lwd = 2)
points(I(Hcom_obs/1000) ~ years, pch = 16, cex = 1.2)
```

### Subsistence

```{r}
Hsub_fit = post_summ(post, "Hsub")/1000
mean_sub_cv = paste0(round(mean(sig2cv(Hsub_obs_sig)), 2) * 100, "%")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(Hsub_fit[3,] ~ years, type = "n", ylim = range(0,Hsub_fit[4:5,]), las = 1,
     main = paste0("Mean Observation CV: ", mean_sub_cv), ylab = "Total Fish (1000s)", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Hsub_fit[4,], rev(Hsub_fit[5,])), col = "grey80", border = NA)
lines(Hsub_fit[4,] ~ years, col = "grey")
lines(Hsub_fit[5,] ~ years, col = "grey")
lines(Hsub_fit[3,] ~ years, lwd = 2)
points(I(Hsub_obs/1000) ~ years, pch = 16, cex = 1.2)
```


`r if (pp_check) "# Posterior Predictive Checks {.tabset .tabset-fade .tabset-pills}"`

`r if (pp_check) "## Abundance"`

```{r N-pp-check, fig.height = 4, fig.width = 8, eval = pp_check}
S_check = lnorm_pp_check(post_subset(post, "^S_t[", T), S_obs_sig, S_obs)
Hcom_check = lnorm_pp_check(post_subset(post, "Hcom[", T), Hcom_obs_sig, Hcom_obs)
Hsub_check = lnorm_pp_check(post_subset(post, "Hsub[", T), Hsub_obs_sig, Hsub_obs)

par(mfrow = c(1,3), mar = c(2,2,1,1), tcl = -0.25, mgp = c(5,0.5,0), oma = c(2,2,0,0))
pp_check_plot(S_check, "Escapement", p_val = T)
pp_check_plot(Hcom_check, "Commercial", p_val = T)
pp_check_plot(Hsub_check, "Subsistence", p_val = T)
mtext(side = 1, outer = T, "Observed Data Fit Measure", line = 0.5)
mtext(side = 2, outer = T, "Simulated Data Fit Measure", line = 0.5)
```

`r if (pp_check) "## Composition"`

```{r comp-pp-check, fig.height = 4, fig.width = 8, eval = pp_check}
com_check = mult_pp_check(post_subset(post, "q_com", T), x_com)
sub_check = mult_pp_check(post_subset(post, "q_sub", T), x_sub)
esc_check = mult_pp_check(post_subset(post, "q_esc", T), x_esc)

par(mfrow = c(1,3), mar = c(2,2,1,1), tcl = -0.25, mgp = c(5,0.5,0), oma = c(2,2,0,0))
pp_check_plot(com_check, "Commercial", p_val = T, axis_q = c(0, 0.99))
pp_check_plot(sub_check, "Subsistence", p_val = T, axis_q = c(0, 0.99))
pp_check_plot(esc_check, "Escapement", p_val = T, axis_q = c(0, 0.99))
mtext(side = 1, outer = T, "Observed Data Fit Measure", line = 0.5)
mtext(side = 2, outer = T, "Simulated Data Fit Measure", line = 0.5)
```

# Selectivity Patterns {.tabset .tabset-fade .tabset-pills}

## Relative Selectivity

Error bars are the central 95% of all years. 

```{r}
v = array_format(post_summ(post, "v[")[3,])

unr_fit = apply(v[,,,1], 3, function(x) apply(x, 2, mean))
unr_lwr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
unr_upr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))
res_fit = apply(v[,,,2], 3, function(x) apply(x, 2, mean))
res_lwr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
res_upr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))

xf = a_min:a_max - 0.05
xm = a_min:a_max + 0.05

par(mfrow = c(1,2), mar = c(2,2,2,0.5), oma = c(1,1.5,0,0))
plot(unr_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     main = "Unrestricted",
     col = "red", pch = 16, type = "o", xaxt = "n", las = 2)
points(unr_fit[,2] ~ xm, xlim = range(xf, xm), col = "blue", pch = 16, type = "o")
segments(xf, unr_lwr[,1], xf, unr_upr[,1], col = "red")
segments(xm, unr_lwr[,2], xm, unr_upr[,2], col = "blue")
legend("bottomright", legend = c("Males", "Females"), pch = 16, col = c("Blue", "red"), lty = 1, pt.cex = 1.2, bg = "grey90", cex = 0.8)
axis(side = 1, at = 4:7, labels = 4:7)

par(mar = c(2,0.5,2,2))
plot(res_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     main = "Restricted",
     yaxt = "n", xaxt = "n", col = "red", pch = 16, type = "o")
points(res_fit[,2] ~ xm, xlim = range(xf, xm), col = "blue", pch = 16, type = "o")
segments(xf, res_lwr[,1], xf, res_upr[,1], col = "red")
segments(xm, res_lwr[,2], xm, res_upr[,2], col = "blue")

axis(side = 1, at = 4:7, labels = 4:7)

mtext(side = 1, line = 0, outer = T, "Age")
mtext(side = 2, line = 0.5, outer = T, "Selectivity")
```

## Posterior v. Prior 

The prior on each selectivity parameter (lambda, sigma, theta, and tau) was normal with mean equal to the estimates presented in Bromaghin (2006), and standard deviation equal to the standard error presented therein times 10 (purposefully uninformative). The "Yukon" estimates are from Bromaghin (2006) with unaltered standard error.

```{r}
par(mfrow = c(2,2), mar = c(2,2,2,2))
junk = sapply(c("Vlam", "Vsig", "Vtha", "Vtau"), function(x) {
  samps = post_subset(post, x, matrix = T)
  dens = apply(samps, 2, density)
  plot(1,1, type = "n", main = x, xlab = "", ylab = "",
       ylim = c(0, max(dens[[1]]$y, dens[[2]]$y, dens[[3]]$y)),
       xlim = range(dens[[1]]$x, dens[[2]]$x, dens[[3]]$x))
  lines(dens[[1]]$y ~ dens[[1]]$x, col = "blue")
  lines(dens[[2]]$y ~ dens[[2]]$x, col = "red")
  lines(dens[[3]]$y ~ dens[[3]]$x, col = "red", lty = 2)
  if (x == "Vlam") {
    legend("topleft", legend = c("Prior", "Posterior", "Yukon"), lty = c(1,1,2), col = c("red", "blue", "red"))
  }
})
```

# Trends in Composition-at-Return {.tabset .tabset-fade .tabset-pills}

`r if (meta$rand_age) "## By Age/Sex {.tabset .tabset-fade .tabset-pills}" else "## By Age/Sex"`

`r if (meta$rand_age) "### Expectations"`

```{r mat-age-sex-expected, fig.width = 8, fig.height = 4}
pi = array_format(post_summ(post, "mu_pi_mat")[3,])

layout(matrix(1:3, 1, 3), widths = c(1,1,0.2))
par(mar = c(2,2,2,2), oma = c(0,1,0,0), xaxs = "i", yaxs = "i",
    cex.axis = 1.4, cex.main = 1.4)
fill_col = c("grey50", "grey65", "grey80", "grey95")
by = 1969:2013
sex = c("Females", "Males")
for (s in 1:2) {
  plot(1,1, type = "n", xlim = range(by), ylim = c(0,1), main = sex[s], las = 1)
  for (a in (na-1):1) {
    if (a == 1) {
      lines(pi[,a,s] ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(pi[,a,s])), col = fill_col[a])
    } else {
      lines(rowSums(pi[,1:a,s]) ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(rowSums(pi[,1:a,s]))), col = fill_col[a])
    }
  }
  box()
}

par(mar = c(0.25, 0.25, 0.25, 0.25))
plot.new()
legend("center", title = "Age", legend = rev(c(4:7)), pch = 22, pt.bg = rev(fill_col), bty = "n", cex = 2, pt.cex = 4)
```

```{r}
df = t(as.data.frame(apply(post_subset(post, "b1_mat[1,", matrix = T), 2, function(x) summ(x, rnd = 4))))
rownames(df) = paste("`", rownames(df), "`", sep = "")
df %>%
  kable(caption = "Posterior summary of the slopes of the female relationships (from a baseline-category logit model)") %>%
  kable_styling(position = "center", full_width = F)
```

```{r}
df = t(as.data.frame(apply(post_subset(post, "b1_mat[2,", matrix = T), 2, function(x) summ(x, rnd = 4))))
rownames(df) = paste("`", rownames(df), "`", sep = "")
df %>%
  kable(caption = "Posterior summary of the slopes of the male relationships (from a baseline-category logit model)") %>%
  kable_styling(position = "center", full_width = F)
```

`r if (meta$rand_age) "### Random Variables"`

```{r mat-age-sex-random, fig.width = 8, fig.height = 4, eval = meta$rand_age}
pi = array_format(post_summ(post, "^p[")[3,])

layout(matrix(1:3, 1, 3), widths = c(1,1,0.2))
par(mar = c(2,2,2,2), oma = c(0,1,0,0), xaxs = "i", yaxs = "i",
    cex.axis = 1.4, cex.main = 1.4)
fill_col = c("grey50", "grey65", "grey80", "grey95")
by = 1969:2013
sex = c("Females", "Males")
for (s in 1:2) {
  plot(1,1, type = "n", xlim = range(by), ylim = c(0,1), main = sex[s], las = 1)
  for (a in (na-1):1) {
    if (a == 1) {
      lines(pi[,a,s] ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(pi[,a,s])), col = fill_col[a])
    } else {
      lines(rowSums(pi[,1:a,s]) ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(rowSums(pi[,1:a,s]))), col = fill_col[a])
    }
  }
  box()
}

par(mar = c(0.25, 0.25, 0.25, 0.25))
plot.new()
legend("center", title = "Age", legend = rev(c(4:7)), pch = 22, pt.bg = rev(fill_col), bty = "n", cex = 2, pt.cex = 4)
```

## By Sex

```{r}
pi_f = post_summ(post, "mu_pi_f")
# p_f = summ_post(post, "p_f")
by = 1969:2013

plot(pi_f[3,] ~ by, type = "l", xlab = "Brood Year", ylab = "Proportion Female Recruits", las = 1, ylim = range(pi_f[4:5,]))
polygon(x = c(by, rev(by)), y = c(pi_f[4,], rev(pi_f[5,])), col = "grey80", border = NA)
lines(pi_f[4,] ~ by, col = "grey")
lines(pi_f[5,] ~ by, col = "grey")
lines(pi_f[3,] ~ by, col = "black", lwd = 2)
```

```{r}
t(as.data.frame(summ(post_subset(post, "b1_sex", matrix = T), rnd = 4))) %>%
  kable(caption = "Posterior summary of the slope of this relationship (from a logit-linear model)", row.names = F) %>%
  kable_styling(position = "center", full_width = F)
```

# Exploitation Rates {.tabset .tabset-fade .tabset-pills}

_These are total exploitation rates, with fishing mortality resulting from both subsistence and commercial fisheries._

## By Year

```{r}
U_fit = post_summ(post, "Utot_t[")[3,]
U_lwr = post_summ(post, "Utot_t[")[4,]
U_upr = post_summ(post, "Utot_t[")[5,]

par(mar = c(2,5,2,2), cex.main = 1.4, cex.axis = 1.4, cex.lab = 1.4)
plot(U_fit ~ years, type = "n", ylim = c(0,1),las = 1,
     ylab = "Exploitation Rate")
polygon(x = c(years, rev(years)), y = c(U_lwr, rev(U_upr)),
        col = "grey80", border = NA)
lines(U_lwr ~ years, col = "grey")
lines(U_upr ~ years, col = "grey")
lines(U_fit ~ years, lwd = 2)
```

## By Age/Year

```{r, fig.height = 8, fig.width = 6}
U_fit = array_format(post_summ(post, "Utot_ta[")[3,])
U_lwr = array_format(post_summ(post, "Utot_ta[")[4,])
U_upr = array_format(post_summ(post, "Utot_ta[")[5,])

par(mfcol = c(4,1), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
ages = a_min:a_max
for (a in 1:na) {
  plot(U_fit[,a] ~ years, type = "n",
       ylim = c(0,1),
       main = paste("Age", ages[a]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a], rev(U_upr[,a])),
          col = "grey80", border = NA)
  lines(U_lwr[,a] ~ years, col = "grey")
  lines(U_upr[,a] ~ years, col = "grey")
  lines(U_fit[,a] ~ years, lwd = 2)
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

## By Age/Sex/Year

```{r, fig.height = 8, fig.width = 6}
U_fit = array_format(post_summ(post, "Utot_tas")[3,])
U_lwr = array_format(post_summ(post, "Utot_tas")[4,])
U_upr = array_format(post_summ(post, "Utot_tas")[5,])

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
sexes = c("Females", "Males")
ages = a_min:a_max
for (s in 1:2) {
  for (a in 1:na) {
    plot(U_fit[,a,s] ~ years, type = "n",
         ylim = c(0,1),
         main = paste("Age", ages[a], sexes[s]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a,s], rev(U_upr[,a,s])), col = "grey80", border = NA)
  lines(U_lwr[,a,s] ~ years, col = "grey")
  lines(U_upr[,a,s] ~ years, col = "grey")
  lines(U_fit[,a,s] ~ years, lwd = 2)
  }
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

# Recruitment Relationship

```{r recruitment plot}
Z = post_summ(post, "^Z_t[")
R = post_summ(post, "R[")
SRA_post = post_subset(post, c("alpha", "beta$"), T)

ricker = function(Z, params) params[1] * Z * exp(-params[2] * Z)

Z_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + Z_ind - 1
Z_pred = seq(0, max(Z[5,Z_ind]), length = 100)

R_div = 1e3
Z_div = 1e6

R_pred = t(apply(SRA_post, 1, function(x) ricker(Z_pred, x)))
R_pred = apply(R_pred, 2, summ)

Z = Z/Z_div
R = R/R_div
Z_pred = Z_pred/Z_div
R_pred = R_pred/R_div

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[3,R_ind] ~ Z[3,Z_ind], type = "n", las = 1,
     xlim = c(0, max(Z[5,Z_ind])) * 1.05,
     ylim = c(0, max(R[5,R_ind])) * 1.05,
     xlab = "Total Reproductive Output (millions)", ylab = "Recruits (1000s)")
polygon(x = c(Z_pred, rev(Z_pred)), y = c(R_pred[4,], rev(R_pred[5,])), 
        col = "grey90", border = NA)
lines(R_pred[4,] ~ Z_pred, col = "grey")
lines(R_pred[5,] ~ Z_pred, col = "grey")
lines(R_pred[3,] ~ Z_pred, lwd = 2)
# text(R[3,R_ind] ~ Z[3,Z_ind],
#      labels = paste("'", substr(by, 3, 4), sep = ""),
#      col = ifelse(by %in% 2011:2013, "red", "black"), font = 2)
segments(Z[4,Z_ind], R[3,R_ind], Z[5,Z_ind], R[3,R_ind], col = "grey")
segments(Z[3,Z_ind], R[4,R_ind], Z[3,Z_ind], R[5,R_ind], col = "grey")
points(R[3,R_ind] ~ Z[3,Z_ind], pch = 16)
```

# Per Capita Reproductive Potential {.tabset .tabset-fade .tabset-pills}

## Per Spawner

```{r}
Z_per_S = post_summ(post, "Z_per_S_t")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(Z_per_S[3,] ~ years, type = "n", ylim = range(Z_per_S[4:5,]),
     main = "", ylab = paste0(pretty_z_unit, "/Spawning Salmon"), xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Z_per_S[4,], rev(Z_per_S[5,])), col = "grey80", border = NA)
lines(Z_per_S[4,] ~ years, col = "grey")
lines(Z_per_S[5,] ~ years, col = "grey")
lines(Z_per_S[3,] ~ years, lwd = 2)
```

## Per Female Spawner

```{r}
Z_per_fS = post_summ(post, "Z_per_female")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(Z_per_fS[3,] ~ years, type = "n", ylim = range(Z_per_fS[4:5,]),
     main = "", ylab = paste0(pretty_z_unit, "/Spawning Female"), xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Z_per_fS[4,], rev(Z_per_fS[5,])), col = "grey80", border = NA)
lines(Z_per_fS[4,] ~ years, col = "grey")
lines(Z_per_fS[5,] ~ years, col = "grey")
lines(Z_per_fS[3,] ~ years, lwd = 2)
```

`r if (jags_code | jags_data) "# JAGS Inputs {.tabset .tabset-fade .tabset-pills}"`

`r if (jags_code) "## JAGS Model"`

```{r jags-code, eval = jags_code, comment = NA}
edit_full_model(
  model_lines = readLines(file.path("../2-model-fit/model-files", "full-model.txt")),
  outfile = "", len_trend = meta$len_trend, age_trend = meta$age_trend, sex_trend = meta$sex_trend,
  keep_comments = T, keep_whitespace = T, rand_age = meta$rand_age
  )
```

`r if (jags_data) "## JAGS Data"`

```{r jags-data, comment = NA, eval = jags_data}
jags_dat
```

