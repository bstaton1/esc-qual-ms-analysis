---
title: "`r paste0('Online Supplement ', LETTERS[m + 1], ' to Staton et al.')`"
subtitle: "`r paste0('_Detailed Output for Model: ', model_ids[model], '_')`"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = "center")

library(postpack)
library(StatonMisc)
library(magrittr)
library(knitr)
library(kableExtra)
library(stringr)
library(scales)

# compile the data
data_dir = "../2-model-fit/inputs"
source("../2-model-fit/1-compile-data.R")

# load in additional functions
source("../load-functions.R")

# location of output files
out_dir = "../../model-output/"

# names of output files
post_name = paste("post-", model, ".rds", sep = "")
meta_name = paste("meta-", model, ".rds", sep = "")
msy_name = paste("msy-", model, ".rds", sep = "")
Rmax_name = paste("Rmax-", model, ".rds", sep = "")

# read in the saved output samples
post = readRDS(file.path(out_dir, post_name))
meta = readRDS(file.path(out_dir, meta_name))
msy = readRDS(file.path(out_dir, msy_name))
Rmax = readRDS(file.path(out_dir, Rmax_name))
```

```{r settings}
mcmc_info   = T  # display MCMC diagnostic info? Takes ~2 minutes
fit         = T  # display model fit figures?
pp_check    = T  # display posterior predictive checks? Takes ~3 minutes
selectivity = T  # display selectivity function plots?
u_rates     = T  # display exploitation rates?
return_comp = T  # display return composition?
sra         = T  # display recruitment relationships?
per_cap     = T  # display per capita reproductive output?
big_tables  = T  # display tables for posterior summaries?
jags_code   = T  # display jags code?
jags_data   = T  # display jags data?
thin_post   = F  # use postpack::post_thin to reduce the size of the calculations?
diag_plot_thin = 0.5  # proportion of samples to thin before traceplotting
```

```{r math-key}
math_key = c(
  "alpha"          = "$\\alpha$",
  "alpha_e3"       = "$\\alpha \\times 10^3$",
  "beta"           = "$\\beta$",
  "beta_e5"        = "$\\beta \\times 10^{5}$",
  "beta_e10"       = "$\\beta \\times 10^{10}$",
  "sigma_R_white"  = "$\\sigma_R$",
  "sigma_R0"       = "$\\sigma_{R_0}$",
  "phi"            = "$\\phi$",
  "mean_R0"        = "$\\dot{R}_0$",
  "log_mean_R0"    = "$\\log(\\dot{R}_0)$",
  "b0_mat[1,1]"    = "$\\gamma_{0,1,1}$",
  "b0_mat[1,2]"    = "$\\gamma_{0,2,1}$",
  "b0_mat[1,3]"    = "$\\gamma_{0,3,1}$",
  "b0_mat[1,4]"    = "$\\gamma_{0,4,1}$",
  "b1_mat[1,1]"    = "$\\gamma_{1,1,1}$",
  "b1_mat[1,2]"    = "$\\gamma_{1,2,1}$",
  "b1_mat[1,3]"    = "$\\gamma_{1,3,1}$",
  "b1_mat[1,4]"    = "$\\gamma_{1,4,1}$",
  "b0_mat[2,1]"    = "$\\gamma_{0,1,2}$",
  "b0_mat[2,2]"    = "$\\gamma_{0,2,2}$",
  "b0_mat[2,3]"    = "$\\gamma_{0,3,2}$",
  "b0_mat[2,4]"    = "$\\gamma_{0,4,2}$",
  "b1_mat[2,1]"    = "$\\gamma_{1,1,2}$",
  "b1_mat[2,2]"    = "$\\gamma_{1,2,2}$",
  "b1_mat[2,3]"    = "$\\gamma_{1,3,2}$",
  "b1_mat[2,4]"    = "$\\gamma_{1,4,2}$",
  "b0_mat"         = "$\\gamma_{0,a,s}$",
  "b1_mat"         = "$\\gamma_{1,a,s}$",
  "b0_sex"         = "$\\delta_{0}$",
  "b1_sex"         = "$\\delta_{1}$",
  "Vtau"           = "$\\tau$",
  "Vsig"           = "$\\sigma$",
  "Vtha"           = "$\\theta$",
  "Vlam"           = "$\\lambda$",
  "R"              = "$R_y$",
  "D_sum"          = "$D$",
  "Fcom"           = "$F_{\\text{com},t}$",
  "Fsub"           = "$F_{\\text{sub},t}$",
  "p"              = "$p$"
)
```

```{r cntr}
# thin the posterior if requested
if (thin_post) post = post_thin(post, thin_percent = 0.9)

# set up a counter
cntr = c(
  Model = model,
  Section = 0,
  Figure = 0,
  Table = 0
)

# function to increment the counter
up_cntr = function(type, cntr, eval = T) {
  if (eval) {
    cntr[type] = cntr[type] + 1
  }
  return(cntr)
}

# function to print a header
create_label = function(type, cntr, inc_type = T, level, sub = "", subb = "", text = "", tabset = F, eval = T) {
  id = paste0(
    "**", 
    ifelse(inc_type & type != "Section", paste0(type, " "), ""),
    cntr[type], 
    ifelse(nchar(sub) > 0, "(", ""), 
    sub, subb,
    ifelse(nchar(sub) > 0, ")", ""), 
    "**"
    )
  hash = paste(rep("#", level), collapse = "")
  tabset_text = " {.tabset .tabset-fade .tabset-pills}"
  
  if (eval) paste0(hash, " ", id, " ", text, ifelse(tabset, tabset_text, ""))
}

model_ids = c("N-0", "N-ASL", "E-0", "E-L", "E-S", "E-A", "E-SL", "E-AL", "E-AS", "E-ASL", "EM-0", "EM-ASL")

```

`r cntr = up_cntr("Section", cntr, T); create_label("Section", cntr, F, level = 1, sub = "", subb = "", text = paste0("Model Description: ", model_ids[model]), tabset = F)`

```{r model-description-table}
pretty_z_unit = paste(capitalize(str_split(z_unit, "_")[[1]]), collapse = " ")

tab = data.frame(
  q = c(
    "Model Number",
    "Units of Reproductive Potential",
    "Length-at-age",
    "Sex-at-return",
    "Age-at-return",
    "Dirichlet age-at-return"
  ),
  v = c(meta$model, pretty_z_unit,
        ifelse(c(meta$len_trend, meta$sex_trend, meta$age_trend, meta$rand_age), "Yes", "No"))
)

if (!meta$rand_age) tab = tab[-nrow(tab),]

colnames(tab) = c("Option", "Setting")

kable(tab, caption = "Assumptions regarding trends and reproductive units in this model.") %>%
  kable_styling(full_width = F) %>%
  group_rows("Trends", 3, 5, italic = T, bold = F)
```

`r cntr = up_cntr("Section", cntr, mcmc_info); create_label("Section", cntr, F, level = 1, sub = "", subb = "", text = "MCMC", tabset = T, mcmc_info)`

`r cntr = up_cntr("Table", cntr, mcmc_info); create_label("Table", cntr, T, level = 2, sub = "", subb = "", text = "Info", tabset = T, mcmc_info)`

`r create_label("Table", cntr, F, level = 3, sub = "a", subb = "", text = "Dimensions", tabset = T, mcmc_info)`

```{r mcmc-dimesion-info, eval = mcmc_info}
n_burn = unname(meta$mcmc.info["n.burnin"])
n_chain = unname(meta$mcmc.info["n.chains"])
n_post = unname(meta$mcmc.info["n.iter"]) - n_burn
n_thin = unname(meta$mcmc.info["n.thin"])
n_adapt = mean(unname(meta$mcmc.info[stringr::str_detect(names(meta$mcmc.info), "adapt")]))
n_save = n_post/n_thin * n_chain
n_total = (n_adapt + n_burn + n_post) * n_chain
tab = data.frame(
  q = c(
    "Adapt",
    "Burn-in",
    "Post-Burn-in",
    "Thinning Interval",
    "Chains",
    "Total Iterations",
    "Saved Iterations"
  ),
  v = prettify(c(n_adapt, n_burn, n_post, n_thin, n_chain, n_total, n_save))
)

colnames(tab) = c("Option", "Setting")

kable(tab, caption = "The MCMC settings used in this run.") %>%
  kable_styling(full_width = F) %>%
  group_rows("Per Chain", 1, 4) %>%
  row_spec(row = 7, bold = T)
```

`r create_label("Table", cntr, F, level = 3, sub = "b", subb = "", text = "Run Time", tabset = F, mcmc_info)`

```{r model-runtime-info, eval = mcmc_info}
elapse = meta$elapsed
elapse = str_split(elapse, " ")[[1]]
elapse = paste(round(abs(as.numeric(elapse[1])), 3), capitalize(elapse[2]), sep = " ")

tab = t(data.frame(Started = meta$starttime, Stopped = meta$stoptime, Elapsed = elapse))

kable(tab,caption = "Model run time information.") %>%
  kable_styling(full_width = F, position = "center") %>%
  row_spec(3, bold = T)
  
```

```{r model-fit-info, eval = F}
## Deviance Statistics
tab = data.frame(
  deviance = post_summ(post, "deviance")["mean",],
  pD = meta$pD, DIC = meta$DIC)
kable(round(tab), caption = "Model fit statistics.", row.names = F) %>%
  kable_styling(full_width = F)
```

`r cntr = cntr = up_cntr("Table", cntr, mcmc_info); create_label("Table", cntr, T, level = 2, sub = "", subb = "", text = "Diagnostic Summaries", tabset = T, mcmc_info)`

`r create_label("Table", cntr, F, level = 3, sub = "a", subb = "", text = "$\\hat{R}$", tabset = F, mcmc_info)`

```{r Rhat-info, eval = mcmc_info}
Rhat = meta$R.hat
params = rownames(Rhat)
if (!meta$rand_age) {
  params = params[-which(params %in% c("p", "D_sum"))]
}
Rhat = Rhat[params,]
Rhat = round(Rhat, 3)

latex = math_key[params]
params = paste("`", params, "`", sep = "")
Rhat = cbind(data.frame(latex = latex, params = params), data.frame(Rhat))
rownames(Rhat) = NULL

Rhat[is.na(Rhat) | Rhat == "Inf" | Rhat == "-Inf"] = "--"
colnames(Rhat) = c("In Text", "In Code", "Mean", "Min", "2.5%", "10%", "25%", "50%", "75%", "90%", "97.5%", "Max")
kable(
  Rhat, format = "html", digits = 2, align = "llcccccccccc",
  caption = "Summaries of the $\\hat{R}$ convergence diagnostic for all estimated parameters/states. Values close to 1 are ideal, values greater than 1.1 are of moderate concern. Summaries were generated across indices of the parameter; for example the max value for $F_{\\text{com},t}$ represents the maximum $\\hat{R}$ value across all years. Parameters that were fixed to have the same value each MCMC iteration have empty cells.", escape = F, row.names = F) %>%
  kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
  add_header_above(c("Quantity" = 2, "Summary Across Indices (where applicable)" = 10))
```

`r create_label("Table", cntr, F, level = 3, sub = "b", subb = "", text = "Effective MCMC Samples", tabset = F, mcmc_info)`

```{r ess-info, eval = mcmc_info}
ess = meta$n.eff
params = rownames(ess)
if (!meta$rand_age) {
  params = params[-which(params %in% c("p", "D_sum"))]
}
params = params[-which(params == "beta")]
ess = ess[params,]
ess = apply(round(ess, -2), 2, prettify)
ess[ess == "0"] = 1

latex = math_key[params]
params = paste("`", params, "`", sep = "")
ess = cbind(data.frame(latex = latex, params = params), data.frame(ess))
rownames(ess) = NULL

colnames(ess) = c("In Text", "In Code", "Mean", "Min", "2.5%", "10%", "25%", "50%", "75%", "90%", "97.5%", "Max")
kable(
  ess, format = "html", align = "llcccccccccc",
  caption = "Summaries of the effective MCMC samples for all estimated parameters/states. Larger values represent more independent samples were drawn. Summaries were generated across indices of the parameter; for example the minimum value for $F_{\\text{com},t}$ represents the minimum effective samples value across all years. Parameters that were fixed to have the same value each MCMC iteration have values of 1. All other cells were rounded to the nearest 100 for ease of presentation.", escape = F, row.names = F) %>%
  kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
  add_header_above(c("Quantity" = 2, "Summary Across Indices (where applicable)" = 10))
```

`r cntr = up_cntr("Figure", cntr, mcmc_info); create_label("Figure", cntr, T, level = 2, sub = "", subb = "", text = "Diagnostic Plots", tabset = T, mcmc_info)`

`r if (mcmc_info & diag_plot_thin > 0) paste0("**NOTE:** The posterior samples were thinned by an additional ", diag_plot_thin * 100, "% for traceplotting (but not for any other content).")`

`r create_label("Figure", cntr, F, level = 3, sub = "a", subb = "", text = "$\\alpha$", tabset = F, mcmc_info)`

```{r alpha-diag-plot, eval = mcmc_info}
par(oma = c(0,0,2,0)); diag_plots(post, "alpha", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "b", subb = "", text = "$\\beta$", tabset = F, mcmc_info)`

```{r beta-diag-plot, eval = mcmc_info}
par(oma = c(0,0,2,0)); diag_plots(post, "beta$", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "c", subb = "", text = "$\\phi$", tabset = F, mcmc_info)`

```{r phi-diag-plot, eval = mcmc_info}
par(oma = c(0,0,2,0)); diag_plots(post, "phi", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "d", subb = "", text = "$\\sigma_R$", tabset = F, mcmc_info)`

```{r sigmaR-diag-plot, eval = mcmc_info}
par(oma = c(0,0,2,0)); diag_plots(post, "sigma_R", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "e", subb = "", text = "Selectivity", tabset = F, mcmc_info)`

```{r V-params-diag-plots, eval = mcmc_info, fig.height = 7}
diag_plots(post, c("^Vtau$", "^Vsig$", "^Vtha$", "^Vlam$"), show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "f", subb = "", text = "Fishing Mortality", tabset = T, mcmc_info)`

`r create_label("Figure", cntr, F, level = 4, sub = "f", subb = "1", text = "Commercial", tabset = F, mcmc_info)`

```{r Fcom-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, "Fcom", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 4, sub = "f", subb = "2", text = "Subsistence", tabset = F, mcmc_info)`

```{r Fsub-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, "Fsub", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "g", subb = "", text = "$R_y$", tabset = F, mcmc_info)`

```{r R-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, "^R[", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "h", subb = "", text = "$\\delta$", tabset = T, mcmc_info)`

`r create_label("Figure", cntr, F, level = 4, sub = "h", subb = "1", text = "$\\delta_0$", tabset = F, mcmc_info)`

```{r b0-sex-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, "b0_sex", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 4, sub = "h", subb = "2", text = "$\\delta_1$", tabset = F, mcmc_info)`

```{r b1-sex-diag-plots, fig.height = 6, fig.width = 9, eval = mcmc_info}
diag_plots(post, "b1_sex", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 3, sub = "i", subb = "", text = "$\\gamma$", tabset = T, mcmc_info)`

`r create_label("Figure", cntr, F, level = 4, sub = "i", subb = "1", text = "$\\gamma_{0,a,s}$", tabset = F, mcmc_info)`

```{r b0-mat-diag-plots, fig.height = 7, eval = mcmc_info}
diag_plots(post, "b0_mat", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, F, level = 4, sub = "i", subb = "2", text = "$\\gamma_{1,a,s}$", tabset = F, mcmc_info)`

```{r b1-mat-diag-plots, fig.height = 7, eval = mcmc_info}
diag_plots(post, "b1_mat", show_diags = "never", thin_percent = diag_plot_thin)
```

`r create_label("Figure", cntr, T, level = 3, sub = "j", subb = "", text = "D_sum", tabset = F, mcmc_info & meta$rand_age)`

```{r D-sum-diag-plot, eval = mcmc_info & meta$rand_age}
par(oma = c(0,0,2,0)); diag_plots(post, "D_sum", show_diags = "never", thin_percent = diag_plot_thin)
```

`r cntr = up_cntr("Section", cntr, fit); create_label("Section", cntr, F, level = 1, sub = "", subb = "", text = "Fit to Data", tabset = T, fit)`

`r if (fit) "In all figures, the red points represent observed information, thick blue lines represent the posterior median, and light blue regions represent 95% equal-tailed credible regions."`

`r cntr = up_cntr("Figure", cntr, fit); create_label("Figure", cntr, T, level = 2, sub = "", subb = "", text = "Composition", tabset = T, fit)`

`r create_label("Figure", cntr, F, level = 3, sub = "a", subb = "", text = "By Age/Sex", tabset = T, fit)`

`r create_label("Figure", cntr, F, level = 4, sub = "a", subb = "1", text = "Escapement", tabset = F, fit)`

```{r esc-age-sex-fit, fig.height = 8, fig.width = 6, eval = fit}
q_fit = array_format(post_summ(post, "q_esc")[3,])
q_lwr = array_format(post_summ(post, "q_esc")[4,])
q_upr = array_format(post_summ(post, "q_esc")[5,])
q_obs = t(apply(x_esc, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "skyblue", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2, col = "blue")
  lines(q_lwr[,as] ~ years, col = "skyblue3")
  lines(q_upr[,as] ~ years, col = "skyblue3")
  points(q_obs[,as] ~ years, pch = 21, bg = alpha("salmon", 0.5), col = "red", cex = 1.4)
}

```

`r create_label("Figure", cntr, F, level = 4, sub = "a", subb = "2", text = "Commercial", tabset = F, fit)`

`r if (fit) "_Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh._"`

```{r com-age-sex-fit, fig.height = 8, fig.width = 6, eval = fit}
q_fit = array_format(post_summ(post, "q_com")[3,])
q_lwr = array_format(post_summ(post, "q_com")[4,])
q_upr = array_format(post_summ(post, "q_com")[5,])
q_obs = t(apply(x_com, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "skyblue", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2, col = "blue")
  lines(q_lwr[,as] ~ years, col = "skyblue3")
  lines(q_upr[,as] ~ years, col = "skyblue3")
  points(q_obs[,as] ~ years, pch = 21, cex = 1.4, col = "red", bg = alpha("salmon", 0.5))
  abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)
}
```

`r create_label("Figure", cntr, F, level = 4, sub = "a", subb = "3", text = "Subsistence", tabset = F, fit)`

`r if (fit) "_Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh._"`

```{r sub-age-sex-fit, fig.height = 8, fig.width = 6, eval = fit}
q_fit = array_format(post_summ(post, "q_sub")[3,])
q_lwr = array_format(post_summ(post, "q_sub")[4,])
q_upr = array_format(post_summ(post, "q_sub")[5,])
q_obs = t(apply(x_sub, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "skyblue", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2, col = "blue")
  lines(q_lwr[,as] ~ years, col = "skyblue3")
  lines(q_upr[,as] ~ years, col = "skyblue3")
  points(q_obs[,as] ~ years, pch = 21, cex = 1.4, col = "red", bg = alpha("salmon", 0.5))
  abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
}
```

`r create_label("Figure", cntr, F, level = 3, sub = "b", subb = "", text = "By Sex", tabset = T, fit)`

`r if (fit) "Although the model fits to sex data on an age-specific basis by data source, we can still look at how well it captures patterns in sex composition."`

`r create_label("Figure", cntr, F, level = 4, sub = "b", subb = "1", text = "Escapement", tabset = F, fit)`

```{r esc-sex-fit, eval = fit}
pf_fit_esc = rowSums(array_format(post_summ(post, "q_esc")[3,])[,1:4])
pf_lwr_esc = rowSums(array_format(post_summ(post, "q_esc")[4,])[,1:4])
pf_upr_esc = rowSums(array_format(post_summ(post, "q_esc")[5,])[,1:4])
pf_esc = rowSums(x_esc[,1:4])/rowSums(x_esc)
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(pf_fit_esc ~ years, type = "l", ylim = c(0,1), las = 1, ylab = "Proportion Females", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(pf_lwr_esc, rev(pf_upr_esc)), col = "skyblue", border = NA)
lines(pf_fit_esc ~ years, lwd = 2, col = "blue")
lines(pf_lwr_esc ~ years, col = "skyblue3")
lines(pf_upr_esc ~ years, col = "skyblue3")
points(pf_esc ~ years, pch = 21, cex = 1.2, col = "red", bg = alpha("salmon", 0.5))
```

`r create_label("Figure", cntr, F, level = 4, sub = "b", subb = "2", text = "Commercial", tabset = F, fit)`

`r if (fit) "_Vertical dashed line represents the year the fishery switched from unrestricted mesh to restricted mesh._"`

```{r com-sex-fit, eval = fit}
pf_fit_com = rowSums(array_format(post_summ(post, "q_com")[3,])[,1:4])
pf_lwr_com = rowSums(array_format(post_summ(post, "q_com")[4,])[,1:4])
pf_upr_com = rowSums(array_format(post_summ(post, "q_com")[5,])[,1:4])
pf_com = rowSums(x_com[,1:4])/rowSums(x_com)
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(pf_fit_com ~ years, type = "l", ylim = c(0,1), las = 1, main = "", ylab = "Proportion Females", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(pf_lwr_com, rev(pf_upr_com)), col = "skyblue", border = NA)
lines(pf_fit_com ~ years, lwd = 2, col = "blue")
lines(pf_lwr_com ~ years, col = "skyblue3")
lines(pf_upr_com ~ years, col = "skyblue3")
points(pf_com ~ years, pch = 21, cex = 1.2, col = "red", bg = alpha("salmon", 0.5))
abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)
```

`r create_label("Figure", cntr, F, level = 4, sub = "b", subb = "3", text = "Subsistence", tabset = F, fit)`

`r if (fit) "_Vertical dashed line represents the year the fishery switched from unrestricted mesh to restricted mesh._"`

```{r sub-sex-fit, eval = fit}
pf_fit_sub = rowSums(array_format(post_summ(post, "q_sub")[3,])[,1:4])
pf_lwr_sub = rowSums(array_format(post_summ(post, "q_sub")[4,])[,1:4])
pf_upr_sub = rowSums(array_format(post_summ(post, "q_sub")[5,])[,1:4])
pf_sub = rowSums(x_sub[,1:4])/rowSums(x_sub)
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(pf_fit_sub ~ years, type = "l", ylim = c(0,1), las = 1, main = "", ylab = "Proportion Females", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(pf_lwr_sub, rev(pf_upr_sub)), col = "skyblue", border = NA)
lines(pf_fit_sub ~ years, lwd = 2, col = "blue")
lines(pf_lwr_sub ~ years, col = "skyblue3")
lines(pf_upr_sub ~ years, col = "skyblue3")
points(pf_sub ~ years, pch = 21, cex = 1.2, col = "red", bg = alpha("salmon", 0.5))
abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
```

`r create_label("Figure", cntr, F, level = 3, sub = "c", subb = "", text = "Multinomial Effective Sample Size", tabset = T, fit)`

`r if (fit) "The multinomial effective sample size for each data set was rescaled such that the year with the most fish sampled for a given data set received an effective sample size of 100. All other years were scaled proportionately to that value, e.g., ESS = n_aged_year/max(n_aged_year) * 100"`

`r create_label("Figure", cntr, F, level = 4, sub = "c", subb = "1", text = "Escapement", tabset = F, fit)`

```{r esc-ess, eval = fit}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_esc, NA), las = 2, ylim = c(0, 100), col = "skyblue", border = "skyblue3", space = 0)
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

`r create_label("Figure", cntr, F, level = 4, sub = "c", subb = "2", text = "Commercial", tabset = F, fit)`

```{r com-ess, eval = fit}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_com, NA), las = 2, ylim = c(0, 100), col = "skyblue", border = "skyblue3", space = 0)
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

`r create_label("Figure", cntr, F, level = 4, sub = "c", subb = "3", text = "Subsistence", tabset = F, fit)`

```{r sub-ess, eval = fit}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_sub, NA), las = 2, ylim = c(0, 100), col = "skyblue", border = "skyblue3", space = 0)
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

`r cntr = up_cntr("Figure", cntr, fit); create_label("Figure", cntr, T, level = 2, sub = "", subb = "", text = "Abundance", tabset = T, eval = fit)`

`r create_label("Figure", cntr, F, level = 3, sub = "a", subb = "", text = "Escapement", tabset = F, fit)`

```{r Sesc-fit, eval = fit}
S_fit = post_summ(post, "^S_t[")/1000
mean_S_cv = paste0(round(mean(sig2cv(S_obs_sig)), 2) * 100, "%")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(S_fit[3,] ~ years, type = "n", ylim = range(0,S_fit[4:5,]), las = 1,
     main = paste0("Mean Observation CV: ", mean_S_cv), ylab = "Total Fish (1000s)", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(S_fit[4,], rev(S_fit[5,])), col = "skyblue", border = NA)
lines(S_fit[4,] ~ years, col = "skyblue3")
lines(S_fit[5,] ~ years, col = "skyblue3")
lines(S_fit[3,] ~ years, lwd = 2, col = "blue")
points(I(S_obs/1000) ~ years, pch = 21, cex = 1.2, col = "red", bg = alpha("salmon", 0.5))
```

`r create_label("Figure", cntr, F, level = 3, sub = "b", subb = "", text = "Commercial", tabset = F, fit)`

```{r Hcom-fit, eval = fit}
Hcom_fit = post_summ(post, "Hcom")/1000
mean_com_cv = paste0(round(mean(sig2cv(Hcom_obs_sig)), 2) * 100, "%")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(Hcom_fit[3,] ~ years, type = "n", ylim = range(0,Hcom_fit[4:5,]), las = 1, 
     main = paste0("Mean Observation CV: ", mean_com_cv), ylab = "Total Fish (1000s)", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Hcom_fit[4,], rev(Hcom_fit[5,])), col = "skyblue", border = NA)
lines(Hcom_fit[4,] ~ years, col = "skyblue3")
lines(Hcom_fit[5,] ~ years, col = "skyblue3")
lines(Hcom_fit[3,] ~ years, lwd = 2, col = "blue")
points(I(Hcom_obs/1000) ~ years, pch = 21, cex = 1.2, col = "red", bg = alpha("salmon", 0.5))
```

`r create_label("Figure", cntr, F, level = 3, sub = "c", subb = "", text = "Subsistence", tabset = F, fit)`

```{r Hsub-fit, eval = fit}
Hsub_fit = post_summ(post, "Hsub")/1000
mean_sub_cv = paste0(round(mean(sig2cv(Hsub_obs_sig)), 2) * 100, "%")
par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(Hsub_fit[3,] ~ years, type = "n", ylim = range(0,Hsub_fit[4:5,]), las = 1,
     main = paste0("Mean Observation CV: ", mean_sub_cv), ylab = "Total Fish (1000s)", xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Hsub_fit[4,], rev(Hsub_fit[5,])), col = "skyblue", border = NA)
lines(Hsub_fit[4,] ~ years, col = "skyblue3")
lines(Hsub_fit[5,] ~ years, col = "skyblue3")
lines(Hsub_fit[3,] ~ years, lwd = 2, col = "blue")
points(I(Hsub_obs/1000) ~ years, pch = 21, cex = 1.2, col = "red", bg = alpha("salmon", 0.5))
```

`r cntr = up_cntr("Section", cntr, pp_check); create_label("Section", cntr, F, level = 1, sub = "", subb = "", text = "Posterior Predictive Checks", tabset = T, pp_check)`

`r cntr = up_cntr("Figure", cntr, pp_check); create_label("Figure", cntr, T, level = 2, sub = "", subb = "", text = "Abundance", tabset = F, pp_check)`

`r if (pp_check) "The metric used to summarize the fit of simulated and observed abundance data from source $k$ in each posterior sample $i$ was:"`

`r if (pp_check) "$$SSQ_{k,i} = \\sum_t^{n_t} \\left(\\log(x_{k,t,i}) - \\log(\\hat{x}_{k,t,i})\\right)^2$$"`

`r if (pp_check) "where $x$ represents the observed or simulated data, and $\\hat{x}$ represents the model expectation for MCMC iteration $i$. If $x$ represents the observed data, it does not have a $i$ subscript but the calculation is the same. The Bayesian $p$-value (upper left corner in the figures below) represents the proportion of MCMC iterations in which $SSQ_{k}$ of the observed data was greater than $SSQ_{k}$ of the simulated data; values close to 0.5 are ideal."`

```{r N-pp-check, fig.height = 3, fig.width = 8, eval = pp_check}
S_check = lnorm_pp_check(post_subset(post, "^S_t[", T), S_obs_sig, S_obs)
Hcom_check = lnorm_pp_check(post_subset(post, "Hcom[", T), Hcom_obs_sig, Hcom_obs)
Hsub_check = lnorm_pp_check(post_subset(post, "Hsub[", T), Hsub_obs_sig, Hsub_obs)

par(mfrow = c(1,3), mar = c(2,2,3,1), tcl = -0.25, mgp = c(5,0.5,0), oma = c(2,2,0,0))
pp_check_plot(S_check, "Escapement", p_val = T)
pp_check_plot(Hcom_check, "Commercial", p_val = T)
pp_check_plot(Hsub_check, "Subsistence", p_val = T)
mtext(side = 1, outer = T, "Observed Data Fit Measure", line = 0.5)
mtext(side = 2, outer = T, "Simulated Data Fit Measure", line = 0.5)
```

`r cntr = up_cntr("Figure", cntr, pp_check); create_label("Figure", cntr, T, level = 2, sub = "", subb = "", text = "Composition", tabset = F, pp_check)`

`r if (pp_check) "The metric used to summarize the fit of simulated and observed composition data from source $k$ in each posterior sample $i$ was:"`

`r if (pp_check) "$$\\chi_{k,i}^2 = \\sum_t^{n_t} \\sum_j^{n_s \\cdot n_a} \\frac{(x_{k,t,j,i} - \\hat{x}_{k,t,j,i})^2}{\\hat{x}_{k,t,j,i}}$$"`

`r if (pp_check) "where $x$ represents the observed or simulated data, and $\\hat{x}$ represents the model expectation for MCMC iteration $i$. $j$ represents a unique age/sex class. If $x$ represents the observed data, it does not have a $i$ subscript but the calculation is the same. The Bayesian $p$-value (upper left corner in the figures below) represents the proportion of MCMC iterations in which $\\chi_{k}^2$ of the observed data was greater than $\\chi_{k}^2$ of the simulated data; values close to 0.5 are ideal."`

```{r comp-pp-check, fig.height = 3, fig.width = 8, eval = pp_check}
com_check = mult_pp_check(post_subset(post, "q_com", T), x_com)
sub_check = mult_pp_check(post_subset(post, "q_sub", T), x_sub)
esc_check = mult_pp_check(post_subset(post, "q_esc", T), x_esc)

par(mfrow = c(1,3), mar = c(2,2,2,1), tcl = -0.25, mgp = c(5,0.5,0), oma = c(2,2,0,0))
pp_check_plot(com_check, "Commercial", p_val = T)
pp_check_plot(sub_check, "Subsistence", p_val = T)
pp_check_plot(esc_check, "Escapement", p_val = T)
mtext(side = 1, outer = T, "Observed Data Fit Measure", line = 0.5)
mtext(side = 2, outer = T, "Simulated Data Fit Measure", line = 0.5)
```

`r cntr = up_cntr("Section", cntr, selectivity); create_label("Section", cntr, T, level = 1, sub = "", subb = "", text = "Selectivity", tabset = T, selectivity)`

`r cntr = up_cntr("Figure", cntr, selectivity); create_label("Figure", cntr, T, level = 2, sub = "a", subb = "", text = "Pearson Function", tabset = F, selectivity)`

`r if (selectivity) "100 posterior draws of the fitted Pearson function. Blue line represents the median across all draws."`

```{r pearson-fig, eval = selectivity}

pearson = function(rlm, lambda, theta, sigma, tau) {
  
  # separate calculation into 5 steps
  t1 = (1 + lambda^2/(4 * theta^2))^theta
  t2 = rlm - (sigma * lambda)/(2 * theta) - tau
  t3 = (1 + t2^2/sigma^2)^-theta
  t4 = exp(-lambda * (atan(t2/sigma) + atan(lambda/(2 * theta))))
  
  v = t1 * t3 * t4
  
  # standardize the output so only one age/sex is fully vuln for a gear
  v/max(v)
}

V_post = post_subset(post, "^V...$", T)

my_pearson = function(rlm, i) {
  unname(pearson(
    rlm, 
    tau = V_post[i,"Vtau"], sigma = V_post[i,"Vsig"], theta = V_post[i,"Vtha"], lambda = V_post[i,"Vlam"]
  ))
}

rlm_seq = seq(min(rlm), max(rlm), length = 100)

V_out = sapply(1:nrow(V_post), my_pearson, rlm = rlm_seq)
V_med = apply(V_out, 1, median)

par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(1,1, type = "n", xlim = range(rlm_seq), ylim = c(min(V_out),1),
     ylab = "Selectivity", xlab = "MEFL:Mesh Perimeter (RLM)", las = 1)
junk = sapply(sample(1:nrow(V_post), min(nrow(V_post), 100)), function(i) {
  lines(V_out[,i] ~ rlm_seq, col = scales::alpha("grey20", 0.2))
})
lines(V_med ~ rlm_seq, col = "blue", lwd = 4)
       
```

`r create_label("Figure", cntr, T, level = 2, sub = "b", subb = "", text = "Age/Sex/Mesh Values", tabset = T, selectivity)`

`r if (selectivity) "Error bars are the central 95% across all years."`

`r create_label("Figure", cntr, F, level = 3, sub = "b", subb = "1", text = "8-inch", tabset = F, selectivity)`

```{r sel-8, fig.width = 4, fig.height = 4, eval = selectivity}

v = array_format(post_summ(post, "v[")[3,])

unr_fit = apply(v[,,,1], 3, function(x) apply(x, 2, mean))
unr_lwr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
unr_upr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))
v = array_format(post_summ(post, "v[")[3,])

xf = a_min:a_max - 0.05
xm = a_min:a_max + 0.05

par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(unr_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     type = "n", xaxt = "n", las = 2,
     xlab = "Age", ylab = "Selectivity", cex = 1.2)
segments(xf, unr_lwr[,1], xf, unr_upr[,1], col = "red")
segments(xm, unr_lwr[,2], xm, unr_upr[,2], col = "blue")
points(unr_fit[,2] ~ xm,  col = "blue", bg = "skyblue", pch = 21, type = "o", cex = 1.2)
points(unr_fit[,1] ~ xf,  col = "red", bg = "salmon", pch = 21, type = "o", cex = 1.2)
legend("bottomright", legend = c("Males", "Females"), pch = 21,
       col = c("blue", "red"), pt.bg = c("skyblue", "salmon"), lty = 1, pt.cex = 1.2, cex = 0.8)
axis(side = 1, at = 4:7, labels = 4:7)

```

`r create_label("Figure", cntr, F, level = 3, sub = "b", subb = "2", text = "6-inch", tabset = F, selectivity)`

```{r sel-6, fig.width = 4, fig.height = 4, eval = selectivity}

v = array_format(post_summ(post, "v[")[3,])

res_fit = apply(v[,,,2], 3, function(x) apply(x, 2, mean))
res_lwr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
res_upr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))

xf = a_min:a_max - 0.05
xm = a_min:a_max + 0.05


par(mar = c(3,3,1,1), mgp = c(2,0.5,0), tcl = -0.25)
plot(res_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     type = "n", xaxt = "n", las = 2,
     xlab = "Age", ylab = "Selectivity", cex = 1.2)
segments(xf, res_lwr[,1], xf, res_upr[,1], col = "red")
segments(xm, res_lwr[,2], xm, res_upr[,2], col = "blue")
points(res_fit[,2] ~ xm,  col = "blue", bg = "skyblue", pch = 21, type = "o", cex = 1.2)
points(res_fit[,1] ~ xf,  col = "red", bg = "salmon", pch = 21, type = "o", cex = 1.2)
legend("bottomright", legend = c("Males", "Females"), pch = 21,
       col = c("blue", "red"), pt.bg = c("skyblue", "salmon"), lty = 1, pt.cex = 1.2, cex = 0.8)
axis(side = 1, at = 4:7, labels = 4:7)


```

`r create_label("Figure", cntr, T, level = 2, sub = "c", subb = "", text = "Posterior vs. Prior", tabset = T, selectivity)`

```{r sel-prior-plot-func, eval = selectivity}
v_prior_plot = function(p) {
  # obtain posterior samples
  post_samps = post_subset(post, paste0("V", p), matrix = T)
  
  # obtain the name of the object controlling the prior
  prior_name = paste0("V", p, "_", meta$Vprior)

  # calculate values: the source (straight as published) and the prior (with se * 10)
  source_p = eval(parse(text = prior_name))
  prior_p = source_p; prior_p[2] = prior_p[2] * 10

  # sample from these distributions: previous versions of code embedded this in the JAGS model
  # need to use truncated normal for sigma and theta parameters
  if (p %in% c("sig", "tha")) {
    source_samps = truncnorm::rtruncnorm(n = nrow(post_samps), a = 0, b = "Inf", mean = source_p[1], sd = source_p[2])
    prior_samps = truncnorm::rtruncnorm(n = nrow(post_samps), a = 0, b = "Inf", mean = prior_p[1], sd = prior_p[2])
  } else {
    source_samps = rnorm(nrow(post_samps), source_p[1], source_p[2])
    prior_samps = rnorm(nrow(post_samps), prior_p[1], prior_p[2])
  }
  
  # combine samples from the three dists
  samps = cbind(post_samps, prior_samps, source_samps)

  # fit KDE to each dist
  dens = apply(samps, 2, density)
  
  # draw a blank plot
  par(mar = c(3,3,1,1), xaxs = "i", yaxs = "i", mgp = c(2,0.5,0), tcl = -0.25)
  plot(1,1, type = "n", xlab = "Parameter Value", ylab = "Density",
       ylim = c(0, max(dens[[1]]$y, dens[[2]]$y, dens[[3]]$y)) * 1.2,
       xlim = range(dens[[1]]$x, dens[[2]]$x, dens[[3]]$x))
  
  # KDE: the prior
  with(dens[[2]], polygon(x = c(x, rev(x)), y = c(y, rep(0, length(y))), col = scales::alpha("orange", 0.5), border = NA))
  lines(dens[[2]]$y ~ dens[[2]]$x, col = "black")
  
  # KDE: the posterior
  with(dens[[1]], polygon(x = c(x, rev(x)), y = c(y, rep(0, length(y))), col = scales::alpha("skyblue4", 0.3), border = NA))
  lines(dens[[1]]$y ~ dens[[1]]$x, col = "blue")
  
  # KDE: the source 
  with(dens[[3]], polygon(x = c(x, rev(x)), y = c(y, rep(0, length(y))), col = scales::alpha("salmon4", 0.3), border = NA))
  lines(dens[[3]]$y ~ dens[[3]]$x, col = "red")
  
  box()
  legend("top", legend = c("Prior", "Posterior", capitalize(meta$Vprior)), pch = 22,
         pt.bg = scales::alpha(c("orange", "skyblue4", "salmon4"), c(0.5, 0.3, 0.3)),
         col = c("black", "blue", "red"), horiz = T, bty = "n", pt.cex = 3)

}
```

```{r, eval = selectivity}
if (meta$Vprior == "kusko") {
  sel_message = 'The prior on each selectivity parameter ($\\tau$, $\\sigma$, $\\theta$, and $\\lambda$) was normal (or truncated normal to ensure $\\sigma>0$ and $\\theta>0$) with mean equal to the estimates from the Kuskokwim lower river sonar site provided by the Alaska Department of Fish and Game (ADF&G; see Birchfield and Smith [2017](http://www.adfg.alaska.gov/FedAidPDFs/FDS19-27.pdf){target="_blank"} for methods), and standard deviation equal to the standard error provided times 10 (purposefully uninformative). The "Kusko" estimates are those provided by ADF&G with unaltered standard error.'
}

if (meta$Vprior == "yukon") {
  sel_message = 'The prior on each selectivity parameter ($\\tau$, $\\sigma$, $\\theta$, and $\\lambda$) was normal (or truncated normal to ensure $\\sigma>0$ and $\\theta>0$) with mean equal to the estimates presented in Bromaghin ([2005](https://doi.org/10.1016/j.fishres.2005.03.004){target="_blank"}), and standard deviation equal to the standard error presented therein times 10 (purposefully uninformative). The "Yukon" estimates are from Bromaghin ([2005](https://doi.org/10.1016/j.fishres.2005.03.004){target="_blank"}) with unaltered standard error.'
}
```


`r if (selectivity) sel_message`

`r create_label("Figure", cntr, F, level = 3, sub = "c", subb = "1", text = "$\\tau$", tabset = F, selectivity)`

```{r Vtau-plot, eval = selectivity}
v_prior_plot("tau")
```

`r create_label("Figure", cntr, F, level = 3, sub = "c", subb = "2", text = "$\\sigma$", tabset = F, selectivity)`

```{r Vsig-plot, eval = selectivity}
v_prior_plot("sig")
```

`r create_label("Figure", cntr, F, level = 3, sub = "c", subb = "3", text = "$\\theta$", tabset = F, selectivity)`

```{r Vtha-plot, eval = selectivity}
v_prior_plot("tha")
```

`r create_label("Figure", cntr, F, level = 3, sub = "c", subb = "4", text = "$\\lambda$", tabset = F, selectivity)`

```{r Vlam-plot, eval = selectivity}
v_prior_plot("lam")
```

`r cntr = up_cntr("Section", cntr, return_comp); create_label("Section", cntr, T, level = 1, sub = "", subb = "", text = "Return Composition", tabset = T, return_comp)`

`r cntr = up_cntr("Figure", cntr, return_comp); create_label("Figure", cntr, T, level = 2, sub = "a", subb = "", text = "By Age/Sex", tabset = ifelse(meta$rand_age, T, F), return_comp)`

`r create_label("Figure", cntr, F, level = 3, sub = "a", subb = "1", text = "Expected", tabset = F, return_comp & meta$rand_age)`

```{r mat-age-sex-expected, fig.width = 8, fig.height = 4, eval = return_comp}
pi = array_format(post_summ(post, "mu_pi_mat")[1,])

layout(matrix(1:3, 1, 3), widths = c(1,1,0.2))
par(mar = c(2,2,2,2), oma = c(2,3,0,0), xaxs = "i", yaxs = "i",
    cex.axis = 1.4, cex.main = 1.4)
# fill_col = c("grey50", "grey65", "grey80", "grey95")
fill_col = rev(brewer_pal(palette = "Blues")(4))
by = 1969:2013
sex = c("Females", "Males")
for (s in 1:2) {
  plot(1,1, type = "n", xlim = range(by), ylim = c(0,1), main = sex[s], las = 1)
  for (a in (na):1) {
    if (a == 1) {
      lines(pi[,a,s] ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(pi[,a,s])), col = fill_col[a])
    } else {
      lines(rowSums(pi[,1:a,s]) ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(rowSums(pi[,1:a,s]))), col = fill_col[a])
    }
  }
  box()
}
mtext(side = 1, outer = T, "Brood Year", line = 1)
mtext(side = 2, outer = T, "Probability of Return-at-Age", line = 1.5)

par(mar = c(0.25, 0.25, 0.25, 0.25))
plot.new()
legend("center", title = "Age", legend = rev(c(4:7)), pch = 22, pt.bg = rev(fill_col), bty = "n", cex = 2, pt.cex = 4)
```

`r create_label("Figure", cntr, F, level = 3, sub = "a", subb = "2", text = "Realized", tabset = F, return_comp & meta$rand_age)`

```{r mat-age-sex-random, fig.width = 8, fig.height = 4, eval = meta$rand_age & return_comp}
pi = array_format(post_summ(post, "^p[")[1,])


layout(matrix(1:3, 1, 3), widths = c(1,1,0.2))
par(mar = c(2,2,2,2), oma = c(2,3,0,0), xaxs = "i", yaxs = "i",
    cex.axis = 1.4, cex.main = 1.4)
# fill_col = c("grey50", "grey65", "grey80", "grey95")
fill_col = rev(brewer_pal(palette = "Blues")(4))
by = 1969:2013
sex = c("Females", "Males")
for (s in 1:2) {
  plot(1,1, type = "n", xlim = range(by), ylim = c(0,1), main = sex[s], las = 1)
  for (a in (na):1) {
    if (a == 1) {
      lines(pi[,a,s] ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(pi[,a,s])), col = fill_col[a])
    } else {
      lines(rowSums(pi[,1:a,s]) ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(rowSums(pi[,1:a,s]))), col = fill_col[a])
    }
  }
  box()
}
mtext(side = 1, outer = T, "Brood Year", line = 1)
mtext(side = 2, outer = T, "Probability of Return-at-Age", line = 1.5)

par(mar = c(0.25, 0.25, 0.25, 0.25))
plot.new()
legend("center", title = "Age", legend = rev(c(4:7)), pch = 22, pt.bg = rev(fill_col), bty = "n", cex = 2, pt.cex = 4)
```

`r create_label("Figure", cntr, T, level = 2, sub = "b", subb = "", text = "By Sex", tabset = F, return_comp)`

```{r mat-sex, eval = return_comp}
pi_f = post_summ(post, "mu_pi_f")
# p_f = summ_post(post, "p_f")
by = 1969:2013
par(mar = c(3.5,3.5,1,1), mgp = c(2.3, 0.4, 0), tcl = -0.25)
plot(pi_f[3,] ~ by, type = "l", xlab = "Brood Year", ylab = "Probability of Return-as-Female", las = 1, ylim = c(0.2, 0.5))
polygon(x = c(by, rev(by)), y = c(pi_f[4,], rev(pi_f[5,])), col = "skyblue", border = NA)
lines(pi_f[4,] ~ by, col = "skyblue3")
lines(pi_f[5,] ~ by, col = "skyblue3")
lines(pi_f[3,] ~ by, col = "blue", lwd = 2)
```

`r cntr = up_cntr("Section", cntr, u_rates); create_label("Section", cntr, T, level = 1, sub = "", subb = "", text = "Exploitation Rates", tabset = T, u_rates)`

`r if (u_rates) "_These are total exploitation rates, with fishing mortality resulting from both subsistence and commercial fisheries._"`

`r cntr = up_cntr("Figure", cntr, u_rates); create_label("Figure", cntr, T, level = 2, sub = "a", subb = "", text = "By Year", tabset = F, u_rates)`

Red points represent the aggregate exploitation rate based on observed data: total catch (subsistence + commercial) divided by total catch + total escapement.

```{r u-tot, eval = u_rates}
U_fit = post_summ(post, "Utot_t[")[3,]
U_lwr = post_summ(post, "Utot_t[")[4,]
U_upr = post_summ(post, "Utot_t[")[5,]

par(mar = c(2,5,2,2), cex.main = 1.4, cex.axis = 1.4, cex.lab = 1.4)
plot(U_fit ~ years, type = "n", ylim = c(0,1),las = 1,
     ylab = "Exploitation Rate")
polygon(x = c(years, rev(years)), y = c(U_lwr, rev(U_upr)),
        col = "skyblue", border = NA)
lines(U_lwr ~ years, col = "skyblue3")
lines(U_upr ~ years, col = "skyblue3")
lines(U_fit ~ years, lwd = 2, col = "blue")

Htot_obs = Hsub_obs + Hcom_obs
x = Htot_obs/(S_obs + Htot_obs)

points(x ~ years, col = "red", bg = scales::alpha("salmon", 0.5), pch = 21)

```

`r create_label("Figure", cntr, T, level = 2, sub = "b", subb = "", text = "By Age/Year", tabset = F, u_rates)`

```{r u-ta, fig.height = 8, fig.width = 6, eval = u_rates}
U_fit = array_format(post_summ(post, "Utot_ta[")[3,])
U_lwr = array_format(post_summ(post, "Utot_ta[")[4,])
U_upr = array_format(post_summ(post, "Utot_ta[")[5,])

par(mfcol = c(4,1), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
ages = a_min:a_max
for (a in 1:na) {
  plot(U_fit[,a] ~ years, type = "n",
       ylim = c(0,1),
       main = paste("Age", ages[a]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a], rev(U_upr[,a])),
          col = "skyblue", border = NA)
  lines(U_lwr[,a] ~ years, col = "skyblue3")
  lines(U_upr[,a] ~ years, col = "skyblue3")
  lines(U_fit[,a] ~ years, lwd = 2, col = "blue")
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

`r create_label("Figure", cntr, T, level = 2, sub = "c", subb = "", text = "By Age/Sex/Year", tabset = F, u_rates)`

```{r u-tas, fig.height = 8, fig.width = 6, eval = u_rates}
U_fit = array_format(post_summ(post, "Utot_tas")[3,])
U_lwr = array_format(post_summ(post, "Utot_tas")[4,])
U_upr = array_format(post_summ(post, "Utot_tas")[5,])

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
sexes = c("Females", "Males")
ages = a_min:a_max
for (s in 1:2) {
  for (a in 1:na) {
    plot(U_fit[,a,s] ~ years, type = "n",
         ylim = c(0,1),
         main = paste("Age", ages[a], sexes[s]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a,s], rev(U_upr[,a,s])), col = "skyblue", border = NA)
  lines(U_lwr[,a,s] ~ years, col = "skyblue3")
  lines(U_upr[,a,s] ~ years, col = "skyblue3")
  lines(U_fit[,a,s] ~ years, lwd = 2, col = "blue")
  }
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

`r cntr = up_cntr("Section", cntr, sra); create_label("Section", cntr, T, level = 1, sub = "", subb = "", text = "Recruitment Relationship", tabset = T, sra)`

`r cntr = up_cntr("Figure", cntr, sra); create_label("Figure", cntr, T, level = 2, sub = "a", subb = "", text = "Regular", tabset = F, sra)`

```{r sra-regular, eval = sra}
Z = post_summ(post, "^Z_t[")
R = post_summ(post, "R[")
SRA_post = post_subset(post, c("alpha", "beta$"), T)

ricker = function(Z, params) params[1] * Z * exp(-params[2] * Z)

Z_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + Z_ind - 1
Z_pred = seq(0, max(Z[5,Z_ind]), length = 100)

R_div = 1e3
Z_div = ifelse(meta$z_unit == "fish_count", 1e3, 1e6)

xlabs = c(
  fish_count = "Total Spawners (1000s)",
  egg_count = "Egg Production of All Spawners (Millions of eggs)",
  egg_mass = "Egg Mass of All Spawners (Millions of grams)"
)

R_pred = t(apply(SRA_post, 1, function(x) ricker(Z_pred, x)))
R_pred = apply(R_pred, 2, summ)

Z = Z/Z_div
R = R/R_div
Z_pred = Z_pred/Z_div
R_pred = R_pred/R_div

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[3,R_ind] ~ Z[3,Z_ind], type = "n", las = 1,
     xlim = c(0, max(Z[5,Z_ind])) * 1.05,
     ylim = c(0, max(R[5,R_ind])) * 1.05,
     xlab = xlabs[meta$z_unit], ylab = "Recruits (1000s)")
polygon(x = c(Z_pred, rev(Z_pred)), y = c(R_pred[4,], rev(R_pred[5,])), 
        col = "skyblue", border = NA)
lines(R_pred[4,] ~ Z_pred, col = "skyblue3")
lines(R_pred[5,] ~ Z_pred, col = "skyblue3")
lines(R_pred[3,] ~ Z_pred, lwd = 2, col = "blue")
# text(R[3,R_ind] ~ Z[3,Z_ind],
#      labels = paste("'", substr(by, 3, 4), sep = ""),
#      col = ifelse(by %in% 2011:2013, "red", "black"), font = 2)
segments(Z[4,Z_ind], R[3,R_ind], Z[5,Z_ind], R[3,R_ind], col = alpha("salmon", 0.5))
segments(Z[3,Z_ind], R[4,R_ind], Z[3,Z_ind], R[5,R_ind], col = alpha("salmon", 0.5))
points(R[3,R_ind] ~ Z[3,Z_ind], pch = 21, col = "red", bg = alpha("salmon", 0.5))

```

`r cntr = up_cntr("Figure", cntr, sra); create_label("Figure", cntr, T, level = 2, sub = "b", subb = "", text = "Brood Years", tabset = F, sra)`

```{r sra-by, eval = sra}
Z = post_summ(post, "^Z_t[")
R = post_summ(post, "R[")
SRA_post = post_subset(post, c("alpha", "beta$"), T)

ricker = function(Z, params) params[1] * Z * exp(-params[2] * Z)

Z_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + Z_ind - 1
Z_pred = seq(0, max(Z[5,Z_ind]), length = 100)

R_div = 1e3
Z_div = ifelse(meta$z_unit == "fish_count", 1e3, 1e6)

xlabs = c(
  fish_count = "Total Spawners (1000s)",
  egg_count = "Egg Production of All Spawners (Millions of eggs)",
  egg_mass = "Egg Mass of All Spawners (Millions of grams)"
)

R_pred = t(apply(SRA_post, 1, function(x) ricker(Z_pred, x)))
R_pred = apply(R_pred, 2, summ)

Z = Z/Z_div
R = R/R_div
Z_pred = Z_pred/Z_div
R_pred = R_pred/R_div

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[3,R_ind] ~ Z[3,Z_ind], type = "n", las = 1,
     xlim = c(0, max(Z[5,Z_ind])) * 1.05,
     ylim = c(0, max(R[5,R_ind])) * 1.05,
     xlab = xlabs[meta$z_unit], ylab = "Recruits (1000s)")
polygon(x = c(Z_pred, rev(Z_pred)), y = c(R_pred[4,], rev(R_pred[5,])), 
        col = "skyblue", border = NA)
lines(R_pred[4,] ~ Z_pred, col = "skyblue3")
lines(R_pred[5,] ~ Z_pred, col = "skyblue3")
lines(R_pred[3,] ~ Z_pred, lwd = 2, col = "blue")
text(R[3,R_ind] ~ Z[3,Z_ind],
     labels = paste("'", substr(by, 3, 4), sep = ""),
     col = alpha("red", 0.5), font = 2)
# segments(Z[4,Z_ind], R[3,R_ind], Z[5,Z_ind], R[3,R_ind], col = alpha("salmon", 0.5))
# segments(Z[3,Z_ind], R[4,R_ind], Z[3,Z_ind], R[5,R_ind], col = alpha("salmon", 0.5))
# points(R[3,R_ind] ~ Z[3,Z_ind], pch = 21, col = "red", bg = alpha("salmon", 0.5))

```

`r cntr = up_cntr("Figure", cntr, sra); create_label("Figure", cntr, T, level = 2, sub = "c", subb = "", text = "Z vs. S", tabset = F, sra)`

`r if (sra & meta$z_unit != "fish_count") "This figure is intended to illustrate how the interpretation of spawning stock abundance changes when considering Z (age/sex/year specific reproductive output times total age/sex/year specific spawners) rather than S (total spawners, regardless of age or sex, all fish assumed equal). Points are scaled to the maximum so they may be plotted over one another on a common scale. Note that many of the arrows point to the left, indicating that the spawning stock in many years is smaller relative to the maximum observed spawning stock when using Z units rather than S units."`

`r if (sra & meta$z_unit == "fish_count") "Because this model treats one spawner as the unit of reproductive contribution, Z and S are the same."`

```{r sra-z-v-s, eval = sra}

Z = post_summ(post, "^Z_t[")
S = post_summ(post, "^S_t[")
R = post_summ(post, "R[")
SRA_post = post_subset(post, c("alpha", "beta$"), T)

ricker = function(Z, params) params[1] * Z * exp(-params[2] * Z)

Z_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + Z_ind - 1
Z_pred = seq(0, max(Z[5,Z_ind]), length = 100)

R_div = 1e3
Z_div = ifelse(meta$z_unit == "fish_count", 1e3, 1e6)

xlabs = c(
  fish_count = "Total Spawners (1000s)",
  egg_count = "Egg Production of All Spawners (Millions of eggs)",
  egg_mass = "Egg Mass of All Spawners (Millions of grams)"
)

R_pred = t(apply(SRA_post, 1, function(x) ricker(Z_pred, x)))
R_pred = apply(R_pred, 2, summ)

Z_pred = Z_pred/max(Z[3,])

Z = Z[3,]/max(Z[3,])
S = S[3,]/max(S[3,])
R = R/R_div
R_pred = R_pred/R_div

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[3,R_ind] ~ Z[Z_ind], type = "n", las = 1,
     xlim = c(0, max(Z_pred)) * 1.05,
     ylim = c(0, max(R[5,R_ind])) * 1.05,
     xlab = "Scaled Reproductive Units", ylab = "Recruits (1000s)")
lines(R_pred[3,] ~ Z_pred, lwd = 2, col = "blue")
points(R[3,R_ind] ~ Z[Z_ind], pch = 16, col = "skyblue", cex = 1.2)
points(R[3,R_ind] ~ S[Z_ind], pch = 1, col = "red", cex = 1.2)
if (meta$z_unit != "fish_count") {
  suppressWarnings(arrows(Z[Z_ind], R[3,R_ind], S[Z_ind], R[3,R_ind], code = 1, length = 0.05))
}

legend("topright", legend = c("Z/max(Z)", "S/max(S)"), 
       pch = c(16, 1), col = c("skyblue", "red"), pt.cex = 1.5, bty = "n")
```

`r cntr = up_cntr("Section", cntr, per_cap); create_label("Section", cntr, T, level = 1, sub = "", subb = "", text = "Per Capita Reproductive Potential", tabset = T, per_cap)`

`r if (per_cap) "Black bars show the mean of the posterior medians for each third of the time series (14 years each). Black dashed line shows the mean of the posterior medians across all years; the secondary _y_-axis shows the percent change from this mean."`

`r cntr = up_cntr("Figure", cntr, per_cap); create_label("Figure", cntr, T, level = 2, sub = ifelse(meta$z_unit == "fish_count", "", "a"), subb = "", text = "Per Spawner", tabset = F, per_cap)`

```{r z-per-s, eval = per_cap}
Z_per_S = post_summ(post, "Z_per_S_t")
par(mar = c(3,3,1,3), mgp = c(2,0.5,0), tcl = -0.25, lend = "square")
plot(Z_per_S[3,] ~ years, type = "n", ylim = range(Z_per_S[4:5,]),
     main = "", ylab = paste0(pretty_z_unit, "/Spawning Salmon"), xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Z_per_S[4,], rev(Z_per_S[5,])), col = "skyblue", border = NA)
lines(Z_per_S[4,] ~ years, col = "skyblue3")
lines(Z_per_S[5,] ~ years, col = "skyblue3")
lines(Z_per_S[3,] ~ years, lwd = 2, col = "blue")
mtext(side = 4, line = 2, "% Change From All Year Average")
x = rep(1:3, each = 14)

means = tapply(Z_per_S[3,], x, mean)
segments(min(years[x == 1]), means[1], max(years[x == 1]), means[1], lty = 1, col = "black", lwd = 5)
segments(min(years[x == 2]), means[2], max(years[x == 2]), means[2], lty = 1, col = "black", lwd = 5)
segments(min(years[x == 3]), means[3], max(years[x == 3]), means[3], lty = 1, col = "black", lwd = 5)

all_mean = mean(Z_per_S[3,])
p_change = seq(0, 3, 0.2)
axis(side = 4, at = all_mean * p_change, labels = paste0((p_change - 1) * 100, "%"))
abline(h = all_mean, lty = 2, lwd = 3)
```

`r create_label("Figure", cntr, T, level = 2, sub = "b", subb = "", text = "Per Female Spawner", tabset = F, per_cap & meta$z_unit != "fish_count")`

```{r z-per-fs, eval = per_cap & meta$z_unit != "fish_count"}
Z_per_fS = post_summ(post, "Z_per_female_t")
par(mar = c(3,3,1,3), mgp = c(2,0.5,0), tcl = -0.25, lend = "square")
plot(Z_per_fS[3,] ~ years, type = "n", ylim = range(Z_per_fS[4:5,]),
     main = "", ylab = paste0(pretty_z_unit, "/Spawning Salmon"), xlab = "Calendar Year")
polygon(x = c(years, rev(years)), y = c(Z_per_fS[4,], rev(Z_per_fS[5,])), col = "skyblue", border = NA)
lines(Z_per_fS[4,] ~ years, col = "skyblue3")
lines(Z_per_fS[5,] ~ years, col = "skyblue3")
lines(Z_per_fS[3,] ~ years, lwd = 2, col = "blue")
mtext(side = 4, line = 2, "% Change From All Year Average")
x = rep(1:3, each = 14)

means = tapply(Z_per_fS[3,], x, mean)
segments(min(years[x == 1]), means[1], max(years[x == 1]), means[1], lty = 1, col = "black", lwd = 5)
segments(min(years[x == 2]), means[2], max(years[x == 2]), means[2], lty = 1, col = "black", lwd = 5)
segments(min(years[x == 3]), means[3], max(years[x == 3]), means[3], lty = 1, col = "black", lwd = 5)

all_mean = mean(Z_per_fS[3,])
p_change = seq(0, 3, 0.2)
axis(side = 4, at = all_mean * p_change, labels = paste0((p_change - 1) * 100, "%"))
abline(h = all_mean, lty = 2, lwd = 3)
```

`r cntr = up_cntr("Section", cntr, big_tables); create_label("Section", cntr, F, level = 1, sub = "", subb = "", text = "Posterior Summaries", tabset = T, big_tables)`

```{r param-table-prep, eval = big_tables}
alpha_e3 = post_subset(post, "alpha", T) * 1e3
colnames(alpha_e3) = "alpha_e3"
beta_e5 = post_subset(post, "beta$", T) * 1e5
colnames(beta_e5) = "beta_e5"
mean_R0 = exp(post_subset(post, "log_mean_R0", T))
colnames(mean_R0) = "mean_R0"

post = post_bind(post, cbind(alpha_e3, beta_e5, mean_R0))

param_names = list(
  sra = c(
    ifelse(meta$z_unit == "fish_count", "alpha$", "alpha_e3"), 
    ifelse(meta$z_unit == "fish_count","beta_e5", "beta_e10"),
    "sigma_R", "phi", "^mean_R0"
    ),
  age_f = c("b._mat[1,"),
  age_m = c("b._mat[2,"),
  sex = c("b._sex"),
  sel = c("^V...$")
)

# lapply(param_names, function(x) match_p(post, x, ubase = T))

# summarize and format the requested posteriors
# starttime = Sys.time()
# cat("  Summarizing Posteriors...")
est_params = as.data.frame(t(post_summ(post,unname(unlist(param_names)))[c(3,1,2,4,5),]))
# stoptime = Sys.time()
# stoptime - starttime

# add a parameter type category
n_matches = unlist(lapply(param_names, function(x) length(match_p(post, x))))
est_params = cbind(group = unlist(sapply(1:length(n_matches), function(x) rep(names(n_matches)[x], n_matches[x]))), est_params)

# make the node name a variable
est_params = cbind(param = rownames(est_params), est_params)
rownames(est_params) = NULL

est_params$latex = math_key[as.character(est_params$param)]
est_params$param = paste0("`", est_params$param, "`")
group = est_params$group
tab = est_params[,c("latex", "param", "50%", "mean", "sd", "2.5%", "97.5%")]
colnames(tab) = c("In Text", "In Code", "Median", "Mean", "SD", "2.5%", "97.5%")

make_table = function(grp) {
  output = tab[group == grp,] %>%
    kable(format = "html", digits = 3, align = "llccccc", escape = F, row.names = F, big.mark = ",") %>%
    kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
    add_header_above(c("Quantity" = 2, "Posterior Summary" = 5))
  
  if (grp %in% c("age_f", "age_m")) {
    output %<>%
      group_rows("Intercepts", 1, 4, bold = T) %>%
      group_rows("Slopes", 5, 8, bold = T)
  }
  output
}
```

`r cntr = up_cntr("Table", cntr, big_tables); create_label("Table", cntr, T, level = 2, sub = "", subb = "", text = "Model Parameters", tabset = T, big_tables)`

`r create_label("Table", cntr, F, level = 3, sub = "a", subb = "", text = "Spawner-Recruit", tabset = F, big_tables)`

`r if (big_tables) make_table("sra")`

`r create_label("Table", cntr, F, level = 3, sub = "b", subb = "", text = "Selectivity", tabset = F, big_tables)`

`r if (big_tables) make_table("sel")`

`r create_label("Table", cntr, F, level = 3, sub = "b", subb = "", text = "Age-at-Return", tabset = T, big_tables)`

`r create_label("Table", cntr, F, level = 4, sub = "b", subb = "1", text = "Females", tabset = F, big_tables)`

`r if (big_tables) make_table("age_f")`

`r create_label("Table", cntr, F, level = 4, sub = "b", subb = "2", text = "Males", tabset = F, big_tables)`

`r if (big_tables) make_table("age_m")`

`r create_label("Table", cntr, F, level = 3, sub = "c", subb = "", text = "Sex-at-Return", tabset = F, big_tables)`

`r if (big_tables) make_table("sex")`

`r cntr = up_cntr("Table", cntr, big_tables); create_label("Table", cntr, T, level = 2, sub = "", subb = "", text = "Derived Quantities", tabset = T, big_tables)`

```{r derived-table-prep, eval = big_tables}
early_keep_t = 1:10; early_keep_y = 1:10
late_keep_t = nt - 9:0; late_keep_y = ny - 9:0
all_keep_t = 1:nt; all_keep_y = 1:ny

samps_early = prep_samples(post, keep_t = early_keep_t, keep_y = early_keep_y, silent = T)
samps_late = prep_samples(post, keep_t = late_keep_t, keep_y = late_keep_y, silent = T)
samps_all = prep_samples(post, keep_t = all_keep_t, keep_y = all_keep_y, silent = T)

samps = list(
  early = matrix2mcmclist(cbind(postpack:::id_mat(post), samps_early)),
  all = matrix2mcmclist(cbind(postpack:::id_mat(post), samps_all)),
  late = matrix2mcmclist(cbind(postpack:::id_mat(post), samps_late))
)

samps = lapply(samps, function(x) post_subset(x, c("v", "pi", "z")))

f = function(post) {
  post_summ(post, c("v", "z", "pi"))[3,]
}

out = as.data.frame(lapply(samps, f))

x = get_p(samps[[1]])

build_name = function(x) {
  symbol = ifelse(str_detect(x, "pi"), "\\bar{\\pi}", 
         ifelse(str_detect(x, "z"), "\\bar{z}", 
                ifelse(str_detect(x, "v"), "\\bar{v}", "")))
  group = ifelse(str_detect(x, "pi"), "pi", 
         ifelse(str_detect(x, "z"), "z", 
                ifelse(str_detect(x, "v"), "v", "")))
  
  sex = ifelse(str_detect(x, "^m"), "Male", "Female")
  age = str_extract(x, "[:digit:]")
  j_key = c(paste0("f", a_min:a_max), paste0("m", a_min:a_max))
  j_num = 1:8
  j = unname(sapply(x, function(j) j_num[str_detect(j_key, str_extract(j, "^[:alnum:]+"))]))
  m = ifelse(str_detect(x, "v_unr"), ",1", 
             ifelse(str_detect(x, "v_res"), ",2", ""))
  group = ifelse(m == ",1", "v_unr", ifelse(m == ",2", "v_res", group))
  data.frame(
    group = group,
    latex = paste0("$", symbol, "_{", "i,", j, m, "}$"),
    sex = sex,
    age = age)
}

out = cbind(build_name(rownames(out)), out)
rownames(out) = NULL

tab = out[,c("latex", "sex", "age", "early", "all", "late")]
group = out[,"group"]
colnames(tab)[1:3] = c("Quantity", "Sex", "Age")
brood_years = 1969:2013
early_t = paste(paste0("'", substr(range(years[early_keep_t]), 3, 4)), collapse= "-")
all_t = paste(paste0("'", substr(range(years[all_keep_t]), 3, 4)), collapse= "-")
late_t = paste(paste0("'", substr(range(years[late_keep_t]), 3, 4)), collapse= "-")
t_names = c(early_t, all_t, late_t)
early_y = paste(paste0("'", substr(range(brood_years[early_keep_y]), 3, 4)), collapse= "-")
all_y = paste(paste0("'", substr(range(brood_years[all_keep_y]), 3, 4)), collapse= "-")
late_y = paste(paste0("'", substr(range(brood_years[late_keep_y]), 3, 4)), collapse= "-")
y_names = c(early_y, all_y, late_y)

grp = "pi"
make_table = function(grp) {
  output = tab[group == grp,]
  if (grp == "pi") {
    colnames(output)[4:6] = y_names
  } else {
    colnames(output)[4:6] = t_names
  }
  
  if (grp == "pi") {
    output %>%
      kable(format = "html", digits = 3, align = "lllccc", escape = F, row.names = F) %>%
      kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
      add_header_above(c(" " = 3, "Brood Year Range" = 3))
  } else {
    output %>%
      kable(format = "html", digits = 3, align = "lllccc", escape = F, row.names = F) %>%
      kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
      add_header_above(c(" " = 3, "Calendar Year Range" = 3))
  }
}
```

`r create_label("Table", cntr, F, level = 3, sub = "a", subb = "", text = "$\\bar{\\pi}_{i,j}$", tabset = F, big_tables)`

`r if (big_tables) if (big_tables) make_table("pi")`

`r create_label("Table", cntr, F, level = 3, sub = "b", subb = "", text = "$\\bar{z}_{i,j}$", tabset = F, big_tables)`

`r if (big_tables) make_table("z")`

`r create_label("Table", cntr, F, level = 3, sub = "c", subb = "", text = "$\\bar{v}_{i,j,m}$", tabset = T, big_tables)`

`r create_label("Table", cntr, F, level = 4, sub = "c", subb = "1", text = "8-inch", tabset = F, big_tables)`

`r if (big_tables) make_table("v_unr")`

`r create_label("Table", cntr, F, level = 4, sub = "c", subb = "2", text = "6-inch", tabset = F, big_tables)`

`r if (big_tables) make_table("v_res")`

```{r msc-table-prep, eval = big_tables}
make_table = function(v) {
  
  x_early = t(msy[c("50%", "2.5%", "97.5%"),c("S", "H", "R"),v,"early"])
  x_all = t(msy[c("50%", "2.5%", "97.5%"),c("S", "H", "R"),v,"all"])
  x_late = t(msy[c("50%", "2.5%", "97.5%"),c("S", "H", "R"),v,"late"])
  
  x = cbind(x_early, x_all, x_late)
  
  x = apply(x, 2, round, digits = -3)
  x = apply(x, 2, prettify)
  x[,1] = paste0("**", x[,1], "**")
  x[,4] = paste0("**", x[,4], "**")
  x[,7] = paste0("**", x[,7], "**")
  params = c("$S_{\\text{MSC}}$", "$H_{\\text{MSC}}$", "$R_{\\text{MSC}}$")
  
  x = cbind(params, x)
  rownames(x) = NULL
  colnames(x)[1] = "Quantity"
  
  kable(x, "html", escape = F, align = "lccccccccc") %>%
    kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
    add_header_above(c(" " = 1, "First 10 Years" = 3, "All Years" = 3, "Last 10 Years" = 3))
}
```

`r create_label("Table", cntr, F, level = 3, sub = "d", subb = "", text = "$\\text{MSC}$", tabset = T, big_tables)`

`r create_label("Table", cntr, F, level = 4, sub = "d", subb = "1", text = "8-inch", tabset = F, big_tables)`

`r if (big_tables) make_table("unr")`

`r create_label("Table", cntr, F, level = 4, sub = "d", subb = "2", text = "6-inch", tabset = F, big_tables)`

`r if (big_tables) make_table("res")`

`r create_label("Table", cntr, F, level = 4, sub = "d", subb = "3", text = "Flat", tabset = F, big_tables)`

`r if (big_tables) make_table("flat")`

```{r Rmax-table-prep, eval = big_tables}
make_table = function(v) {
  
  x_early = t(Rmax[c("50%", "2.5%", "97.5%"),c("S", "H", "R"),v,"early"])
  x_all = t(Rmax[c("50%", "2.5%", "97.5%"),c("S", "H", "R"),v,"all"])
  x_late = t(Rmax[c("50%", "2.5%", "97.5%"),c("S", "H", "R"),v,"late"])
  
  x = cbind(x_early, x_all, x_late)
  
  x = apply(x, 2, round, digits = -3)
  x = apply(x, 2, prettify)
  x[,1] = paste0("**", x[,1], "**")
  x[,4] = paste0("**", x[,4], "**")
  x[,7] = paste0("**", x[,7], "**")
  params = c("$S_{R_{\\text{MAX}}}$", "$$H_{R_{\\text{MAX}}}$$", "$$R_{\\text{MAX}}$$")
  
  x = cbind(params, x)
  rownames(x) = NULL
  colnames(x)[1] = "Quantity"
  
  kable(x, "html", escape = F, align = "lccccccccc") %>%
    kable_styling(full_width = F, bootstrap_options = c("condensed")) %>%
    add_header_above(c(" " = 1, "First 10 Years" = 3, "All Years" = 3, "Last 10 Years" = 3))
}
```

`r create_label("Table", cntr, F, level = 3, sub = "e", subb = "", text = "Max. Recruits", tabset = T, big_tables)`

`r create_label("Table", cntr, F, level = 4, sub = "e", subb = "1", text = "8-inch", tabset = F, big_tables)`

`r if (big_tables) make_table("unr")`

`r create_label("Table", cntr, F, level = 4, sub = "e", subb = "2", text = "6-inch", tabset = F, big_tables)`

`r if (big_tables) make_table("res")`

`r create_label("Table", cntr, F, level = 4, sub = "e", subb = "3", text = "Flat", tabset = F, big_tables)`

`r if (big_tables) make_table("flat")`

`r cntr = up_cntr("Section", cntr, jags_data | jags_code); create_label("Section", cntr, T, level = 1, sub = "", subb = "", text = "JAGS Inputs", tabset = T, jags_data | jags_code)`

`r if (jags_code) "## Model Definition"`

```{r jags-code, eval = jags_code, comment = NA}
edit_full_model(
  model_lines = readLines(file.path("../2-model-fit/model-files", "full-model.txt")),
  outfile = "", age_trend = meta$age_trend, sex_trend = meta$sex_trend, z_unit = meta$z_unit,
  keep_comments = T, keep_whitespace = T, rand_age = meta$rand_age
  )
```

`r if (jags_data) "## Input Data"`

```{r jags-data, eval = jags_data, comment = NA}
jags_dat
```
