---
title: "Kuskokwim Age/Sex Structured BSSSRA"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = "center")
library(codaTools)
library(StatonMisc)
library(dplyr)
library(knitr)
library(kableExtra)

# compile the data
source("../2-model-fit/1-compile-data.R")

# load in additional functions
source("../new-func-source.R")
model = 7

# read in the saved posterior samples
post = readRDS(paste("../../model-output/post-", model, ".rds", sep = ""))
# post = codaTools::thin_post(post, 0.8)
meta = readRDS(paste("../../model-output/meta-", model, ".rds", sep = ""))
EGinfo = readRDS(paste("../../model-output/goals-", model, ".rds", sep = ""))
msy = paste("../../model-output/msy-", model, ".rds", sep = "")

years = 1976:2017
```

```{r options}
mcmc_dim = T
mcmc_diag = T

model_code = T
model_data = T
```

# Model Description

```{r}

tab = data.frame(
  q = c(
    "Model Number",
    "Reproductive Units",
    "Fecundity",
    "Sex-based Maturation",
    "Age-based Maturation",
    "Vulnerability"
  ),
  v = c(meta$model, ifelse(meta$eggs, "Eggs", "Fish"),
        ifelse(c(meta$eggs_trend, meta$sex_trend, meta$mat_trend, meta$vuln_trend), "Yes", "No"))
)

colnames(tab) = c("Option", "Setting")

kable(tab, caption = "Assumptions regarding trends and reproductive units in this model.") %>%
  kable_styling(full_width = T) %>%
  group_rows("Trends", 3, 6, italic = T, bold = F)
```

`r if (mcmc_dim | mcmc_diag) "# MCMC"` 

`r if (mcmc_dim) "## Dimensions"`
```{r get-mcmc, eval = mcmc_dim}

n_burn = unname(meta$mcmc.info["n.burnin"])
n_chain = unname(meta$mcmc.info["n.chains"])
n_post = unname(meta$mcmc.info["n.iter"]) - n_burn
n_thin = unname(meta$mcmc.info["n.thin"])
n_adapt = mean(unname(meta$mcmc.info[stringr::str_detect(names(meta$mcmc.info), "adapt")]))
n_save = n_post/n_thin * n_chain
n_total = (n_adapt + n_burn + n_post) * n_chain
tab = data.frame(
  q = c(
    "Adapt",
    "Burn-in",
    "Post-Burn-in",
    "Thinning Interval",
    "Chains",
    "Total Iterations",
    "Saved Iterations"
  ),
  v = prettify(c(n_adapt, n_burn, n_post, n_thin, n_chain, n_total, n_save))
)

colnames(tab) = c("Option", "Setting")

kable(tab, caption = "The MCMC settings used in this run.") %>%
  kable_styling(full_width = T) %>%
  group_rows("Per Chain", 1, 4) %>%
  row_spec(row = 7, bold = T)

elapse = meta$elapsed
elapse = unlist(strsplit(elapse, " "))

elapse = paste(round(abs(as.numeric(elapse[1])), 2), capitalize(elapse[2]), sep = " ")

kable(data.frame(Started = meta$starttime, Stopped = meta$stoptime, Elapsed = elapse),caption = "Model run time information.") %>%
  kable_styling(full_width = T)

tab = data.frame(
  deviance = summ_post(post, "deviance")["mean",],
  pD = meta$pD, DIC = meta$DIC)
kable(round(tab), caption = "Model fit statistics.", row.names = F) %>%
  kable_styling(full_width = T)
```

`r if (mcmc_diag) "## Convergence"`
```{r convergence, eval = mcmc_diag}

bgr = meta$R.hat
ess = meta$n.eff
params = rownames(bgr)
params = paste("`", params, "`", sep = "")
rownames(bgr) = rownames(ess) = NULL

bgr = apply(bgr, 2, function(x) round(x, 2))
ess = apply(ess, 2, function(x) prettify(round(x)))

bgr = cbind(Parameter = params, bgr)
ess = cbind(Parameter = params, ess)

kable(
  bgr, 
  caption = "Summaries of the Brooks-Gelman-Rubin convergence diagnostic for key parameters/states across years, where applicable.", escape = F, row.names = F) %>%
  kable_styling(full_width = T)
  
kable(
  ess, 
  caption = "Summaries of the effective sample size diagnostic for key parameters/states across years, where applicable.", escape = F, row.names = F) %>%
  kable_styling(full_width = T)

```

`r if (mcmc_diag) "## Diagnostic Plots"`

```{r plot-convergence, eval = mcmc_diag}
diag_plots(post, "D_sum")
diag_plots(post, "alpha")
diag_plots(post, "beta")
diag_plots(post, c("^Vtau$", "^Vsig$", "^Vtha$", "^Vlam$"))
diag_plots(post, c("Fcom[1]", "Fcom[11]", "Fcom[22]", "Fcom[33]"))
diag_plots(post, c("Fsub[1]", "Fsub[11]", "Fsub[22]", "Fsub[33]"))
```

# Fit to Age/Sex Comp

## Escapement

```{r, fig.height = 8, fig.width = 6}
q_fit = native_format(summ_post(post, "q_esc")[3,])
q_lwr = native_format(summ_post(post, "q_esc")[4,])
q_upr = native_format(summ_post(post, "q_esc")[5,])
q_obs = t(apply(x_esc, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
}

```

### Effective Sample Size

```{r}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_esc, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

## Commercial

Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh.

```{r, fig.height = 8, fig.width = 6}
q_fit = native_format(summ_post(post, "q_com")[3,])
q_lwr = native_format(summ_post(post, "q_com")[4,])
q_upr = native_format(summ_post(post, "q_com")[5,])
q_obs = t(apply(x_com, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
  abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)
}
```

### Effective Sample Size

```{r}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_com, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

## Subsistence

Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh.

```{r, fig.height = 8, fig.width = 6}
q_fit = native_format(summ_post(post, "q_sub")[3,])
q_lwr = native_format(summ_post(post, "q_sub")[4,])
q_upr = native_format(summ_post(post, "q_sub")[5,])
q_obs = t(apply(x_sub, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
  abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
}


```

### Effective Sample Size

```{r}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_sub, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

```{r, eval = F}
## Goodness of Fit

q_fit_sub = native_format(summ_post(post, "q_sub")[3,])
x_fit_sub = apply(q_fit_sub, 2, function(x) x * ifelse(n_sub == 0, NA, n_sub))
X2_sub = rowSums((x_sub - x_fit_sub)^2/x_fit_sub)

q_fit_com = native_format(summ_post(post, "q_com")[3,])
x_fit_com = apply(q_fit_com, 2, function(x) x * ifelse(n_com == 0, NA, n_com))
X2_com = rowSums((x_com - x_fit_com)^2/x_fit_com)

q_fit_esc = native_format(summ_post(post, "q_esc")[3,])
x_fit_esc = apply(q_fit_esc, 2, function(x) x * ifelse(n_esc == 0, NA, n_esc))
X2_esc = rowSums((x_esc - x_fit_esc)^2/x_fit_esc)


tab = data.frame(year = years,
                 sub_x2 = round(X2_sub, 2),
                 sub_p = round(X2_sub/n_sub, 2),
                 com_x2 = round(X2_com,2),
                 com_p = round(X2_com/n_com,2),
                 esc_x2 = round(X2_esc, 2),
                 esc_p = round(X2_esc/n_esc, 2))

aves = round(colMeans(tab, na.rm = T), 2); aves[1] = "Average"
sums = round(colSums(tab, na.rm = T), 2); sums[1] = "Sum"

plot(esc_p ~ year, data = tab)
points(com_p ~ year, data = tab, pch = 16)
points(sub_p ~ year, data = tab, pch = 17)
# tab = rbind(tab, aves, sums)
# tab[is.na(tab)] = ""
# 
# kable(tab, caption = "$\\chi^2$ goodness of fit scores for each of the multinomial likelioods. x2 are $\\chi^2$ values each year, and p are the values of x2/ESS that year.", row.names = F, escape = F) %>%
#   kable_styling(position = "center", full_width = F) %>%
#   column_spec(1, bold = T) %>%
#   row_spec(nrow(tab) - c(1,0), bold = T)

```

# Fit to Sex Composition

Although the model fits to sex data on an age-specific basis, we can still look at how well it captures patterns in sex composition.

Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh.

```{r, fig.height = 8, fig.width = 6}
pf_fit_com = rowSums(native_format(summ_post(post, "q_com")[3,])[,1:4])
pf_lwr_com = rowSums(native_format(summ_post(post, "q_com")[4,])[,1:4])
pf_upr_com = rowSums(native_format(summ_post(post, "q_com")[5,])[,1:4])
pf_fit_sub = rowSums(native_format(summ_post(post, "q_sub")[3,])[,1:4])
pf_lwr_sub = rowSums(native_format(summ_post(post, "q_sub")[4,])[,1:4])
pf_upr_sub = rowSums(native_format(summ_post(post, "q_sub")[5,])[,1:4])
pf_fit_esc = rowSums(native_format(summ_post(post, "q_esc")[3,])[,1:4])
pf_lwr_esc = rowSums(native_format(summ_post(post, "q_esc")[4,])[,1:4])
pf_upr_esc = rowSums(native_format(summ_post(post, "q_esc")[5,])[,1:4])

pf_com = rowSums(x_com[,1:4])/rowSums(x_com)
pf_sub = rowSums(x_sub[,1:4])/rowSums(x_sub)
pf_esc = rowSums(x_esc[,1:4])/rowSums(x_esc)

par(mfrow = c(3,1), mar = c(2,4,2,2), cex.axis = 1.2, oma = c(3,3,0,0), cex.main = 1.5)

plot(pf_fit_esc ~ years, type = "l", ylim = c(0,1), las = 1, main = "Escapement", ylab = "")
polygon(x = c(years, rev(years)), y = c(pf_lwr_esc, rev(pf_upr_esc)), col = "grey80", border = NA)
lines(pf_fit_esc ~ years, lwd = 2)
lines(pf_lwr_esc ~ years, col = "grey")
lines(pf_upr_esc ~ years, col = "grey")
points(pf_esc ~ years, pch = 16, cex = 1.2)

plot(pf_fit_com ~ years, type = "l", ylim = c(0,1), las = 1, main = "Commercial", ylab = "")
polygon(x = c(years, rev(years)), y = c(pf_lwr_com, rev(pf_upr_com)), col = "grey80", border = NA)
lines(pf_fit_com ~ years, lwd = 2)
lines(pf_lwr_com ~ years, col = "grey")
lines(pf_upr_com ~ years, col = "grey")
points(pf_com ~ years, pch = 16, cex = 1.2)
abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)

plot(pf_fit_sub ~ years, type = "l", ylim = c(0,1), las = 1, main = "Subsistence", ylab = "")
polygon(x = c(years, rev(years)), y = c(pf_lwr_sub, rev(pf_upr_sub)), col = "grey80", border = NA)
lines(pf_fit_sub ~ years, lwd = 2)
lines(pf_lwr_sub ~ years, col = "grey")
lines(pf_upr_sub ~ years, col = "grey")
points(pf_sub ~ years, pch = 16, cex = 1.2)
abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
mtext(side = 1, outer = T, "Calendar Year", line = 1)
mtext(side = 2, outer = T, "Proportion Females")

```

# Fit to Escapement and Harvest States

```{r, fig.height = 8, fig.width = 6}
Hsub_fit = summ_post(post, "Hsub")/1000
Hcom_fit = summ_post(post, "Hcom")/1000
S_fit = summ_post(post, "^S_t[")/1000


par(mfrow = c(3,1), mar = c(2,4,2,2), cex.axis = 1.2, oma = c(3,3,0,0), cex.main = 1.5)

plot(S_fit[3,] ~ years, type = "l", ylim = range(0, S_fit[4:5,], S_obs/1000), main = "Escapement", ylab = "", las = 1)
polygon(x = c(years, rev(years)),
        y = c(S_fit[4,], rev(S_fit[5,])),
        col = "grey80", border = NA)
lines(S_fit[4,] ~ years, col = "grey")
lines(S_fit[5,] ~ years, col = "grey")
lines(S_fit[3,] ~ years, lwd = 2)
points(I(S_obs/1000) ~ years, pch = 16, cex = 1.2)

plot(Hcom_fit[3,] ~ years, type = "l", ylim = range(0, Hcom_fit[4:5,], Hcom_obs/1000), main = "Commerical", ylab = "")
polygon(x = c(years, rev(years)),
        y = c(Hcom_fit[4,], rev(Hcom_fit[5,])),
        col = "grey80", border = NA)
lines(Hcom_fit[4,] ~ years, col = "grey")
lines(Hcom_fit[5,] ~ years, col = "grey")
lines(Hcom_fit[3,] ~ years, lwd = 2)
points(I(Hcom_obs/1000) ~ years, pch = 16, cex = 1.2)

plot(Hsub_fit[3,] ~ years, type = "l", ylim = range(0, Hsub_fit[4:5,], Hsub_obs/1000), main = "Subsistence", ylab = "")
polygon(x = c(years, rev(years)),
        y = c(Hsub_fit[4,], rev(Hsub_fit[5,])),
        col = "grey80", border = NA)
lines(Hsub_fit[4,] ~ years, col = "grey")
lines(Hsub_fit[5,] ~ years, col = "grey")
lines(Hsub_fit[3,] ~ years, lwd = 2)
points(I(Hsub_obs/1000) ~ years, pch = 16, cex = 1.2)

mtext(side = 1, outer = T, "Calendar Year", line = 1)
mtext(side = 2, outer = T, "Fish (1000s)")
```

# Vulnerability Patterns

Error bars are the central 95% of all years. 

```{r}
v = native_format(summ_post(post, "v[")[3,])

unr_fit = apply(v[,,,1], 3, function(x) apply(x, 2, mean))
unr_lwr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
unr_upr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))
res_fit = apply(v[,,,2], 3, function(x) apply(x, 2, mean))
res_lwr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
res_upr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))

xf = a_min:a_max - 0.05
xm = a_min:a_max + 0.05

par(mfrow = c(1,2), mar = c(2,2,2,0.5), oma = c(1,1.5,0,0))
plot(unr_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     main = "Unrestricted",
     col = "red", pch = 16, type = "o", xaxt = "n", las = 2)
points(unr_fit[,2] ~ xm, xlim = range(xf, xm), col = "blue", pch = 16, type = "o")
segments(xf, unr_lwr[,1], xf, unr_upr[,1], col = "red")
segments(xm, unr_lwr[,2], xm, unr_upr[,2], col = "blue")
legend("bottomright", legend = c("Males", "Females"), pch = 16, col = c("Blue", "red"), lty = 1, pt.cex = 1.2, bg = "grey90", cex = 0.8)
axis(side = 1, at = 4:7, labels = 4:7)

par(mar = c(2,0.5,2,2))
plot(res_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     main = "Restricted",
     yaxt = "n", xaxt = "n", col = "red", pch = 16, type = "o")
points(res_fit[,2] ~ xm, xlim = range(xf, xm), col = "blue", pch = 16, type = "o")
segments(xf, res_lwr[,1], xf, res_upr[,1], col = "red")
segments(xm, res_lwr[,2], xm, res_upr[,2], col = "blue")

axis(side = 1, at = 4:7, labels = 4:7)

mtext(side = 1, line = 0, outer = T, "Age")
mtext(side = 2, line = 0.5, outer = T, "Selectivity")

```

## Posterior v. Prior 

The prior on each parameter was normal with mean equal to the estimates presented in Bromaghin (2006), and standard deviation equal to the standard error presented therein times 10. 

```{r}
par(mfrow = c(2,2), mar = c(2,2,2,2))
junk = sapply(c("Vlam", "Vsig", "Vtha", "Vtau"), function(x) {
  samps = filter_post(post, x, format = "matrix")
  dens = apply(samps, 2, density)
  plot(1,1, type = "n", main = x, xlab = "", ylab = "",
       ylim = c(0, max(dens[[1]]$y, dens[[2]]$y, dens[[3]]$y)),
       xlim = range(dens[[1]]$x, dens[[2]]$x, dens[[3]]$x))
  lines(dens[[1]]$y ~ dens[[1]]$x, col = "blue")
  lines(dens[[2]]$y ~ dens[[2]]$x, col = "red")
  lines(dens[[3]]$y ~ dens[[3]]$x, col = "red", lty = 2)
  if (x == "Vlam") {
    legend("topleft", legend = c("Prior", "Posterior", "Yukon"), lty = c(1,1,2), col = c("red", "blue", "red"))
  }
})
```

# Maturity Trends

```{r, fig.width = 8, fig.height = 4}
pi = native_format(summ_post(post, "mu_pi_mat")[3,])

layout(matrix(1:3, 1, 3), widths = c(1,1,0.2))
par(mar = c(2,2,2,2), oma = c(0,1,0,0), xaxs = "i", yaxs = "i",
    cex.axis = 1.4, cex.main = 1.4)
fill_col = c("grey50", "grey65", "grey80", "grey95")
by = 1969:2013
sex = c("Females", "Males")
for (s in 1:2) {
  plot(1,1, type = "n", xlim = range(by), ylim = c(0,1), main = sex[s], las = 1)
  for (a in (na-1):1) {
    if (a == 1) {
      lines(pi[,a,s] ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(pi[,a,s])), col = fill_col[a])
    } else {
      lines(rowSums(pi[,1:a,s]) ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(rowSums(pi[,1:a,s]))), col = fill_col[a])
    }
  }
  box()
}

par(mar = c(0.25, 0.25, 0.25, 0.25))
plot.new()
legend("center", title = "Age", legend = rev(c(4:7)), pch = 22, pt.bg = rev(fill_col), bty = "n", cex = 2, pt.cex = 4)
```

# Sex Trends

Points are random beta deviates for each brood year. _Considering removing the random beta effects here._

```{r}
par(mar = c(4,5,1,1))
pi_f = summ_post(post, "mu_pi_f")
# p_f = summ_post(post, "p_f")
by = 1969:2013

plot(pi_f[3,] ~ by, type = "l", xlab = "Brood Year", ylab = "Proportion Female Recruits", las = 1, ylim = range(pi_f[4:5,]))
polygon(x = c(by, rev(by)), y = c(pi_f[4,], rev(pi_f[5,])), col = "grey80", border = NA)
lines(pi_f[4,] ~ by, col = "grey")
lines(pi_f[5,] ~ by, col = "grey")
lines(pi_f[3,] ~ by, col = "black", lwd = 2)
# points(p_f[3,] ~ by)

```

```{r}
t(as.data.frame(summ(filter_post(post, "b1_sex", format = "matrix"), rnd = 4))) %>%
  kable(caption = "Posterior summary of the slope of this relationship (a logit-linear model)", row.names = F) %>%
  kable_styling(position = "center", full_width = F)
```

```{r}
t(as.data.frame(summ(exp(filter_post(post, "b1_sex", format = "matrix")), rnd = 4))) %>%
  kable(caption = "Posterior summary of the odds ratio multiplier ($e^{slope}$)", row.names = F, escape = F)%>%
  kable_styling(position = "center", full_width = F)
```

# Exploitation Rates

_These are total exploitation rates, with fishing mortality resulting from both subsistence and commercial._

## Year

```{r}
U_fit = summ_post(post, "Utot_t[")[3,]
U_lwr = summ_post(post, "Utot_t[")[4,]
U_upr = summ_post(post, "Utot_t[")[5,]

par(mar = c(2,5,2,2), cex.main = 1.4, cex.axis = 1.4, cex.lab = 1.4)
plot(U_fit ~ years, type = "n", ylim = c(0,1),las = 1,
     ylab = "Exploitation Rate")
polygon(x = c(years, rev(years)), y = c(U_lwr, rev(U_upr)),
        col = "grey80", border = NA)
lines(U_lwr ~ years, col = "grey")
lines(U_upr ~ years, col = "grey")
lines(U_fit ~ years, lwd = 2)
```

## Age/Year

```{r, fig.height = 8, fig.width = 6}
U_fit = native_format(summ_post(post, "Utot_ta[")[3,])
U_lwr = native_format(summ_post(post, "Utot_ta[")[4,])
U_upr = native_format(summ_post(post, "Utot_ta[")[5,])

par(mfcol = c(4,1), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
ages = a_min:a_max
for (a in 1:na) {
  plot(U_fit[,a] ~ years, type = "n",
       ylim = c(0,1),
       main = paste("Age", ages[a]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a], rev(U_upr[,a])),
          col = "grey80", border = NA)
  lines(U_lwr[,a] ~ years, col = "grey")
  lines(U_upr[,a] ~ years, col = "grey")
  lines(U_fit[,a] ~ years, lwd = 2)
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

## Age/Sex/Year

```{r, fig.height = 8, fig.width = 6}
U_fit = native_format(summ_post(post, "Utot_tas")[3,])
U_lwr = native_format(summ_post(post, "Utot_tas")[4,])
U_upr = native_format(summ_post(post, "Utot_tas")[5,])

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
sexes = c("Females", "Males")
ages = a_min:a_max
for (s in 1:2) {
  for (a in 1:na) {
    plot(U_fit[,a,s] ~ years, type = "n",
         ylim = c(0,1),
         main = paste("Age", ages[a], sexes[s]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a,s], rev(U_upr[,a,s])), col = "grey80", border = NA)
  lines(U_lwr[,a,s] ~ years, col = "grey")
  lines(U_upr[,a,s] ~ years, col = "grey")
  lines(U_fit[,a,s] ~ years, lwd = 2)
  }
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

# Spawner-Recruit Relationship

`r eggs = ifelse(meta$eggs, T, F)`
`r fish = ifelse(meta$eggs, F, T)`

```{r fish-sra, eval = fish}
S = summ_post(post, "^S_t[")
R = summ_post(post, "R[")
SRA_post = filter_post(post, c("alpha", "beta"), "matrix")

ricker = function(S, params) {
  params[1] * S * exp(-params[2] * S)
}

S_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + S_ind - 1
S_pred = seq(0, max(S[5,S_ind]), length = 100)

R_pred = t(apply(SRA_post, 1, function(x) ricker(S_pred, x)))
R_pred = apply(R_pred, 2, summ)

S = S/1000
R = R/1000
S_pred = S_pred/1000
R_pred = R_pred/1000

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[3,R_ind] ~ S[3,S_ind], type = "n", las = 1,
     xlim = c(0, max(S[5,S_ind])) * 1.05,
     ylim = c(0, max(R[5,R_ind])) * 1.05,
     xlab = "Spawners (1000s)", ylab = "Recruits (1000s)")
polygon(x = c(S_pred, rev(S_pred)), y = c(R_pred[4,], rev(R_pred[5,])), 
        col = "grey90", border = NA)
lines(R_pred[4,] ~ S_pred, col = "grey")
lines(R_pred[5,] ~ S_pred, col = "grey")
lines(R_pred[3,] ~ S_pred)
# text(R[3,R_ind] ~ S[3,S_ind], 
#      labels = paste("'", substr(by, 3, 4), sep = ""), 
#      col = ifelse(by %in% 2011:2013, "red", "black"), font = 2)
segments(S[4,S_ind], R[3,R_ind], S[5,S_ind], R[3,R_ind], col = "grey")
segments(S[3,S_ind], R[4,R_ind], S[3,S_ind], R[5,R_ind], col = "grey")
points(R[3,R_ind] ~ S[3,S_ind], pch = 16)
abline(0,1, lty = 2)
```

```{r eggs-sra, eval = eggs}
S = summ_post(post, "^eggs_t[")
R = summ_post(post, "R[")
SRA_post = filter_post(post, c("alpha", "beta"), "matrix")

ricker = function(S, params) {
  params[1] * S * exp(-params[2] * S)
}

S_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + S_ind - 1
S_pred = seq(0, max(S[5,S_ind]), length = 100)

R_pred = t(apply(SRA_post, 1, function(x) ricker(S_pred, x)))
R_pred = apply(R_pred, 2, summ)

S = S/1e6
R = R/1000
S_pred = S_pred/1e6
R_pred = R_pred/1000

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[3,R_ind] ~ S[3,S_ind], type = "n", las = 1,
     xlim = c(0, max(S[5,S_ind])) * 1.05,
     ylim = c(0, max(R[5,R_ind])) * 1.05,
     xlab = "Eggs (Millions)", ylab = "Recruits (1000s)")
polygon(x = c(S_pred, rev(S_pred)), y = c(R_pred[4,], rev(R_pred[5,])), 
        col = "grey90", border = NA)
lines(R_pred[4,] ~ S_pred, col = "grey")
lines(R_pred[5,] ~ S_pred, col = "grey")
lines(R_pred[3,] ~ S_pred)
# text(R[3,R_ind] ~ S[3,S_ind], 
#      labels = paste("'", substr(by, 3, 4), sep = ""), 
#      col = ifelse(by %in% 2011:2013, "red", "black"), font = 2)
segments(S[4,S_ind], R[3,R_ind], S[5,S_ind], R[3,R_ind], col = "grey")
segments(S[3,S_ind], R[4,R_ind], S[3,S_ind], R[5,R_ind], col = "grey")
points(R[3,R_ind] ~ S[3,S_ind], pch = 16)
abline(0,1, lty = 2)
```

```{r, eval = eggs}
S = summ_post(post, "^S_t[")
eggs = summ_post(post, "^eggs_t[")

S_scale = S[3,]/max(S[3,])
eggs_scale = eggs[3,]/max(eggs[3,])

R = summ_post(post, "R[")
SRA_post = filter_post(post, c("alpha", "beta"), "matrix")

ricker = function(S, params) {
  params[1] * S * exp(-params[2] * S)
}

S_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + S_ind - 1
S_pred = seq(0, max(eggs[5,S_ind]), length = 100)

R_pred = t(apply(SRA_post, 1, function(x) ricker(S_pred, x)))
R_pred = apply(R_pred, 2, summ)

S_pred = S_pred/max(eggs[3,])
S = S[3,]/max(S[3,])
eggs = eggs[3,]/max(eggs[3,])
R = R[3,]/1000
R_pred = R_pred/1000

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[R_ind] ~ S[S_ind], type = "n", las = 1,
     xlim = c(0, max(S_pred)) * 1.05,
     ylim = c(0, max(R[R_ind])) * 1.05,
     xlab = "Eggs or Spawners as a Fraction of Max", ylab = "Recruits (1000s)")
polygon(x = c(S_pred, rev(S_pred)), y = c(R_pred[4,], rev(R_pred[5,])), 
        col = "grey90", border = NA)
lines(R_pred[4,] ~ S_pred, col = "grey")
lines(R_pred[5,] ~ S_pred, col = "grey")
lines(R_pred[3,] ~ S_pred)
text(R[R_ind] ~ S[S_ind],
     labels = paste("", substr(by, 3, 4), sep = ""), cex = 0.8,
     col = "black", font = 1)
# segments(S[4,S_ind], R[3,R_ind], S[5,S_ind], R[3,R_ind], col = "grey")
# segments(S[3,S_ind], R[4,R_ind], S[3,S_ind], R[5,R_ind], col = "grey")
# points(R[R_ind] ~ S[S_ind], pch = 1)
points(R[R_ind] ~ eggs[S_ind], pch = 16)
arrows(S[S_ind], R[R_ind], 
       ifelse(eggs[S_ind] < S[S_ind], eggs[S_ind] + 0.02, eggs[S_ind] - 0.02), R[R_ind], length = 0.05)
# abline(0,1, lty = 2)
legend("topright", legend = c("Eggs", "Spawners"), pch = c(16, 89), bty = "n")


```

```{r, eval = meta$eggs, fig.height = 5, fig.width = 4}
d = eggs - S
par(mar = c(5,5,1,1), cex.axis = 1.2, cex.lab = 1.2)
plot(1,1,type = "n", ylim = rev(range(years)), xlim = max(abs(d)) * c(-1,1), las = 1, xlab = "Scaled Eggs - Scaled Spawners", ylab = "")
lines(years ~ d, col = "grey")
points(years ~ d, pch = 16, cex = 1.2)
abline(v = 0, lty = 2)
axis(side = 2, at = years, labels = rep("", nt), tcl = -0.2)
axis(side = 2, at = 1985 + seq(0, 30, 10), labels = rep("", 4), tcl = -0.35)
```

`r if(meta$eggs) "_'Scaled' means each years' quantity divided by the max observed across years_"`


```{r, eval= F}
tab = t(summ_post(post, c("alpha", "beta", "sigma_R_white", "phi")))
tab["beta",] = tab["beta",] * 1e5
rownames(tab) = c("$\\alpha$", "$\\beta \\times 10^5$", "$\\sigma_R$", "$\\phi$")
kable(tab, digits = 2, escape = F) %>% 
  kable_styling(full_width = F)
```

`r if (model_code) "# JAGS Model Code"`

```{r, eval = model_code, echo = F, comment = NA}
edit_full_model(
  model_lines = readLines(file.path("../2-model-fit/model-files", "full-model.txt")),
  outfile = "",
  eggs = meta$eggs, eggs_trend = meta$eggs_trend, sex_trend = meta$sex_trend,
  vuln_trend = meta$vuln_trend, mat_trend = meta$mat_trend,
  keep_comments = T, keep_whitespace = T
  )
```

`r if (model_data) "# JAGS Data Inputs"`

```{r, eval = model_data}
jags_dat
```
