---
title: "Kuskokwim Age/Sex Structured BSSSRA"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = "center")
library(codaTools)
library(StatonMisc)
library(dplyr)
library(knitr)
library(kableExtra)

# compile the data
source("../2-model-fit/1-compile-data.R")

# load in additional functions
# source("../new-func-source.R")

# read in the saved posterior samples
post = readRDS("../../model-output/post-3.rds")
# post = codaTools::thin_post(post, 0.8)
meta = readRDS("../../model-output/meta-3.rds")

years = 1976:2017
```

```{r description}
desc = c(
  "*  **Index of reproductive potential**: spawners, no attention paid to sex or age",
  "*  **Index of reproductive potential**: spawners, no attention paid to sex or age",
  "*  **Vulnerability**: Pearson net selectivity model, estimates four parameters with diffuse priors",
  "*  **Maturity**: independent time trend across brood years for each age and sex-specific exectation, random deviates drawn from these time varying expectations"
)

# *  **Sex Composition**: time trend across brood years for proportion of recruits that mature as females, random deviates drawn from this time varying expectation
# *  **Fishing mortality**: time varying for both commercial and subsistence harvest, subsistence mortality happens first
# *  **Fits to**: age/sex composition of commerical, subsistence, and escapement. Total harvest from commerical and subsistence, total escapement
```

```{r options}
mod_desc = F
mcmc_dim = T
mcmc_diag = T

model_code = F
model_data = F
```

`r if (mod_desc) "# Model Description"`

`r if (mod_desc) paste(desc, collapse = "\n")`

`r if (mcmc_dim | mcmc_diag) "# MCMC"` 

`r if (mcmc_dim) "## Dimensions"`
```{r get-mcmc, eval = mcmc_dim}

n_burn = unname(meta$mcmc.info["n.burnin"])
n_chain = unname(meta$mcmc.info["n.chains"])
n_post = unname(meta$mcmc.info["n.iter"]) - n_burn
n_thin = unname(meta$mcmc.info["n.thin"])
n_adapt = mean(unname(meta$mcmc.info[stringr::str_detect(names(meta$mcmc.info), "adapt")]))
n_save = n_post/n_thin * n_chain
n_total = (n_adapt + n_burn + n_post) * n_chain
tab = data.frame(
  q = c(
    "Adapt",
    "Burn-in",
    "Post-Burn-in",
    "Thinning Interval",
    "Chains",
    "Total Iterations",
    "Saved Iterations"
  ),
  v = prettify(c(n_adapt, n_burn, n_post, n_thin, n_chain, n_total, n_save))
)

colnames(tab) = c("Option", "Setting")

kable(tab, caption = "The MCMC settings used in this run.") %>%
  kable_styling(full_width = T) %>%
  group_rows("Per Chain", 1, 4) %>%
  row_spec(row = 7, bold = T)

elapse = meta$elapsed
elapse = unlist(strsplit(elapse, " "))

elapse = paste(round(abs(as.numeric(elapse[1])), 2), capitalize(elapse[2]), sep = " ")

kable(data.frame(Started = meta$starttime, Stopped = meta$stoptime, Elapsed = elapse),caption = "Model run time information.") %>%
  kable_styling(full_width = T)

tab = data.frame(
  deviance = summ_post(post, "deviance")["mean",],
  pD = meta$pD, DIC = meta$DIC)
kable(round(tab), caption = "Model fit statistics.", row.names = F) %>%
  kable_styling(full_width = T)
```

`r if (mcmc_diag) "## Convergence"`
```{r convergence, eval = mcmc_diag}

main_p = c("alpha", "beta", "sigma_R_white", "sigma_R0", "phi", "D_sum", "^p[", "^R[", "Fcom", "Fsub", "^Vlam$", "^Vtau$", "^Vtha$", "^Vsig$", "mu_pi_mat", "mu_pi_f")
           # "p[", "Fcom", "Fsub", "^Vtau$", , ) #"D_sum"
# main_p = c("alpha", "beta", "U_msy", "S_msy")

tmp_summ = function(z, na.rm = F) {
  c(Mean = mean(z, na.rm = na.rm),
    Median = median(z, na.rm = na.rm),
    Min = min(z, na.rm = na.rm),
    Max = max(z, na.rm = na.rm)
    )
}

diags = summ_post(post, main_p, bgr = T, ess = T)[c("bgr", "ess"),]
all_p = colnames(diags)
diags = sapply(main_p, function(x) {
  list(diags[,stringr::str_detect(all_p, ins_regex_bracket(x))])
})

bgr = t(as.data.frame(lapply(diags, function(x) {
  if (is.matrix(x)) {
    tmp_summ(x["bgr",], na.rm = T)
  } else {
    tmp_summ(x["bgr"], na.rm = T)
  }
})))
ess = t(as.data.frame(lapply(diags, function(x) {
  if (is.matrix(x)) {
    tmp_summ(x["ess",], na.rm = T)
  } else {
    tmp_summ(x["ess"], na.rm = T)
  }
})))
bgr = apply(bgr, 2, function(x) round(x, 2))
ess = apply(ess, 2, function(x) prettify(round(x)))

ps = stringr::str_replace(rownames(bgr), "X\\.", "")
ps = stringr::str_replace(ps, "\\.", "")

ps = ifelse(ps == "Fcom", "$F_{\\text{com},t}$", ps)
ps = ifelse(ps == "Fsub", "$F_{\\text{sub},t}$", ps)
ps = ifelse(ps == "phi", "$\\phi$", ps)
ps = ifelse(ps == "D_sum", "$D_s$", ps)
ps = ifelse(ps %in% c("alpha", "beta"), paste("$\\", ps, "$", sep = ""), ps)
ps = ifelse(ps == "sigma_R_white", "$\\sigma_R$", ps)
ps = ifelse(ps == "sigma_R0", "$\\sigma_{R_0}$", ps)
ps = ifelse(ps == "R", "$R_{y}$", ps)
ps = ifelse(ps == "Vlam", "$\\lambda_{\\text{vuln}}$", ps)
ps = ifelse(ps == "Vtau", "$\\tau_{\\text{vuln}}$", ps)
ps = ifelse(ps == "Vtha", "$\\theta_{\\text{vuln}}$", ps)
ps = ifelse(ps == "Vsig", "$\\sigma_{\\text{vuln}}$", ps)
ps = ifelse(ps == "p", "$p_{y,a,s}$", ps)
ps = ifelse(ps == "mu_pi_mat", "$\\pi_{y,a,s}$", ps)
ps = ifelse(ps == "mu_pi_f", "$\\pi_{y,\\text{female}}$", ps)

bgr = data.frame(Parameter = ps, bgr); rownames(bgr) = NULL
bgr = bgr[order(bgr$Mean, decreasing = T),]
ess = data.frame(Parameter = ps, ess); rownames(ess) = NULL
ess = ess[order(as.numeric(gsub(pattern = ",", replacement = "", as.character(ess$Mean)))),]

kable(
  bgr, 
  caption = "Summaries of the Brooks-Gelman-Rubin convergence diagnostic for key parameters/states across years, where applicable.", escape = F, row.names = F) %>%
  kable_styling(full_width = T)
  
kable(
  ess, 
  caption = "Summaries of the effective sample size diagnostic for key parameters/states across years, where applicable.", escape = F, row.names = F) %>%
  kable_styling(full_width = T)

```

`r if (mcmc_diag) "## Convergence of $D$"`

```{r D convergence, eval = mcmc_diag}
diag_plots(post, "D_sum")
```

# Fit to Age/Sex Comp

## Escapement

```{r, fig.height = 8, fig.width = 6}
q_fit = native_format(summ_post(post, "q_esc")[3,])
q_lwr = native_format(summ_post(post, "q_esc")[4,])
q_upr = native_format(summ_post(post, "q_esc")[5,])
q_obs = t(apply(x_esc, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
}

```

### Effective Sample Size

```{r}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_esc, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

## Commercial

Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh.

```{r, fig.height = 8, fig.width = 6}
q_fit = native_format(summ_post(post, "q_com")[3,])
q_lwr = native_format(summ_post(post, "q_com")[4,])
q_upr = native_format(summ_post(post, "q_com")[5,])
q_obs = t(apply(x_com, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
  abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)
}
```

### Effective Sample Size

```{r}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_com, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

## Subsistence

Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh.

```{r, fig.height = 8, fig.width = 6}
q_fit = native_format(summ_post(post, "q_sub")[3,])
q_lwr = native_format(summ_post(post, "q_sub")[4,])
q_upr = native_format(summ_post(post, "q_sub")[5,])
q_obs = t(apply(x_sub, 1, function(x) x/sum(x)))

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,2,0,0), cex.main = 1.4, cex.axis = 1.4)
sex = rep(c("Females", "Males"), each = na)
age_v = rep(a_min:a_max, 2)
for (as in 1:8) {
  plot(q_fit[,as] ~ years, type = "n", ylim = range(c(q_lwr[,as], q_upr[,as], q_obs[,as]), na.rm = T),
       main = paste("Age", age_v[as], sex[as]), las = 1)
  polygon(x = c(years, rev(years)), y = c(q_lwr[,as], rev(q_upr[,as])), col = "grey80", border = NA)
  lines(q_fit[,as] ~ years, lwd = 2)
  lines(q_lwr[,as] ~ years, col = "grey")
  lines(q_upr[,as] ~ years, col = "grey")
  points(q_obs[,as] ~ years, pch = 16, cex = 1.4)
  abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
}


```

### Effective Sample Size

```{r}
par(xaxs = "i", yaxs = "i", mar = c(3,3,1,1), mgp = c(2,0.75,0), cex.axis = 1.2)
mp = barplot(c(NA, n_sub, NA), las = 2, ylim = c(0, 100))
axis(side = 1, at = mp[c(NA, years, NA) %in% seq(1980, 2015, 5)], labels = seq(1980, 2015, 5), line = 0, las = 2)
axis(side = 1, at = mp[2:(nt+1)], labels = rep("", nt), line = 0, las = 2, tcl = -0.2)
box()
```

```{r, eval = F}
## Goodness of Fit

q_fit_sub = native_format(summ_post(post, "q_sub")[3,])
x_fit_sub = apply(q_fit_sub, 2, function(x) x * ifelse(n_sub == 0, NA, n_sub))
X2_sub = rowSums((x_sub - x_fit_sub)^2/x_fit_sub)

q_fit_com = native_format(summ_post(post, "q_com")[3,])
x_fit_com = apply(q_fit_com, 2, function(x) x * ifelse(n_com == 0, NA, n_com))
X2_com = rowSums((x_com - x_fit_com)^2/x_fit_com)

q_fit_esc = native_format(summ_post(post, "q_esc")[3,])
x_fit_esc = apply(q_fit_esc, 2, function(x) x * ifelse(n_esc == 0, NA, n_esc))
X2_esc = rowSums((x_esc - x_fit_esc)^2/x_fit_esc)


tab = data.frame(year = years,
                 sub_x2 = round(X2_sub, 2),
                 sub_p = round(X2_sub/n_sub, 2),
                 com_x2 = round(X2_com,2),
                 com_p = round(X2_com/n_com,2),
                 esc_x2 = round(X2_esc, 2),
                 esc_p = round(X2_esc/n_esc, 2))

aves = round(colMeans(tab, na.rm = T), 2); aves[1] = "Average"
sums = round(colSums(tab, na.rm = T), 2); sums[1] = "Sum"

plot(esc_p ~ year, data = tab)
points(com_p ~ year, data = tab, pch = 16)
points(sub_p ~ year, data = tab, pch = 17)
# tab = rbind(tab, aves, sums)
# tab[is.na(tab)] = ""
# 
# kable(tab, caption = "$\\chi^2$ goodness of fit scores for each of the multinomial likelioods. x2 are $\\chi^2$ values each year, and p are the values of x2/ESS that year.", row.names = F, escape = F) %>%
#   kable_styling(position = "center", full_width = F) %>%
#   column_spec(1, bold = T) %>%
#   row_spec(nrow(tab) - c(1,0), bold = T)

```

# Fit to Sex Composition

Although the model fits to sex data on an age-specific basis, we can still look at how well it captures patterns in sex composition.

Vertical dashed lines represent the year the fishery switched from unrestricted mesh to restricted mesh.

```{r, fig.height = 8, fig.width = 6}
pf_fit_com = rowSums(native_format(summ_post(post, "q_com")[3,])[,1:4])
pf_lwr_com = rowSums(native_format(summ_post(post, "q_com")[4,])[,1:4])
pf_upr_com = rowSums(native_format(summ_post(post, "q_com")[5,])[,1:4])
pf_fit_sub = rowSums(native_format(summ_post(post, "q_sub")[3,])[,1:4])
pf_lwr_sub = rowSums(native_format(summ_post(post, "q_sub")[4,])[,1:4])
pf_upr_sub = rowSums(native_format(summ_post(post, "q_sub")[5,])[,1:4])
pf_fit_esc = rowSums(native_format(summ_post(post, "q_esc")[3,])[,1:4])
pf_lwr_esc = rowSums(native_format(summ_post(post, "q_esc")[4,])[,1:4])
pf_upr_esc = rowSums(native_format(summ_post(post, "q_esc")[5,])[,1:4])

pf_com = rowSums(x_com[,1:4])/rowSums(x_com)
pf_sub = rowSums(x_sub[,1:4])/rowSums(x_sub)
pf_esc = rowSums(x_esc[,1:4])/rowSums(x_esc)

par(mfrow = c(3,1), mar = c(2,4,2,2), cex.axis = 1.2, oma = c(3,3,0,0), cex.main = 1.5)

plot(pf_fit_esc ~ years, type = "l", ylim = c(0,1), las = 1, main = "Escapement", ylab = "")
polygon(x = c(years, rev(years)), y = c(pf_lwr_esc, rev(pf_upr_esc)), col = "grey80", border = NA)
lines(pf_fit_esc ~ years, lwd = 2)
lines(pf_lwr_esc ~ years, col = "grey")
lines(pf_upr_esc ~ years, col = "grey")
points(pf_esc ~ years, pch = 16, cex = 1.2)

plot(pf_fit_com ~ years, type = "l", ylim = c(0,1), las = 1, main = "Commercial", ylab = "")
polygon(x = c(years, rev(years)), y = c(pf_lwr_com, rev(pf_upr_com)), col = "grey80", border = NA)
lines(pf_fit_com ~ years, lwd = 2)
lines(pf_lwr_com ~ years, col = "grey")
lines(pf_upr_com ~ years, col = "grey")
points(pf_com ~ years, pch = 16, cex = 1.2)
abline(v = years[min(which(com_mesh == 2))] - 0.5, lty = 2)

plot(pf_fit_sub ~ years, type = "l", ylim = c(0,1), las = 1, main = "Subsistence", ylab = "")
polygon(x = c(years, rev(years)), y = c(pf_lwr_sub, rev(pf_upr_sub)), col = "grey80", border = NA)
lines(pf_fit_sub ~ years, lwd = 2)
lines(pf_lwr_sub ~ years, col = "grey")
lines(pf_upr_sub ~ years, col = "grey")
points(pf_sub ~ years, pch = 16, cex = 1.2)
abline(v = years[min(which(sub_mesh == 2))] - 0.5, lty = 2)
mtext(side = 1, outer = T, "Calendar Year", line = 1)
mtext(side = 2, outer = T, "Proportion Females")

```

# Fit to Escapement and Harvest States

```{r, fig.height = 8, fig.width = 6}
Hsub_fit = summ_post(post, "Hsub")/1000
Hcom_fit = summ_post(post, "Hcom")/1000
S_fit = summ_post(post, "S_t[")/1000


par(mfrow = c(3,1), mar = c(2,4,2,2), cex.axis = 1.2, oma = c(3,3,0,0), cex.main = 1.5)

plot(S_fit[3,] ~ years, type = "l", ylim = range(0, S_fit[4:5,], S_obs/1000), main = "Escapement", ylab = "", las = 1)
polygon(x = c(years, rev(years)),
        y = c(S_fit[4,], rev(S_fit[5,])),
        col = "grey80", border = NA)
lines(S_fit[4,] ~ years, col = "grey")
lines(S_fit[5,] ~ years, col = "grey")
lines(S_fit[3,] ~ years, lwd = 2)
points(I(S_obs/1000) ~ years, pch = 16, cex = 1.2)

plot(Hcom_fit[3,] ~ years, type = "l", ylim = range(0, Hcom_fit[4:5,], Hcom_obs/1000), main = "Commerical", ylab = "")
polygon(x = c(years, rev(years)),
        y = c(Hcom_fit[4,], rev(Hcom_fit[5,])),
        col = "grey80", border = NA)
lines(Hcom_fit[4,] ~ years, col = "grey")
lines(Hcom_fit[5,] ~ years, col = "grey")
lines(Hcom_fit[3,] ~ years, lwd = 2)
points(I(Hcom_obs/1000) ~ years, pch = 16, cex = 1.2)

plot(Hsub_fit[3,] ~ years, type = "l", ylim = range(0, Hsub_fit[4:5,], Hsub_obs/1000), main = "Subsistence", ylab = "")
polygon(x = c(years, rev(years)),
        y = c(Hsub_fit[4,], rev(Hsub_fit[5,])),
        col = "grey80", border = NA)
lines(Hsub_fit[4,] ~ years, col = "grey")
lines(Hsub_fit[5,] ~ years, col = "grey")
lines(Hsub_fit[3,] ~ years, lwd = 2)
points(I(Hsub_obs/1000) ~ years, pch = 16, cex = 1.2)

mtext(side = 1, outer = T, "Calendar Year", line = 1)
mtext(side = 2, outer = T, "Fish (1000s)")
```

# Vulnerability Patterns

Error bars are the central 95% of all years. 

```{r}
v = native_format(summ_post(post, "v[")[3,])

unr_fit = apply(v[,,,1], 3, function(x) apply(x, 2, mean))
unr_lwr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
unr_upr = apply(v[,,,1], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))
res_fit = apply(v[,,,2], 3, function(x) apply(x, 2, mean))
res_lwr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.025)))
res_upr = apply(v[,,,2], 3, function(x) apply(x, 2, function(z) quantile(z, 0.975)))

xf = a_min:a_max - 0.05
xm = a_min:a_max + 0.05

par(mfrow = c(1,2), mar = c(2,2,2,0.5), oma = c(1,1.5,0,0))
plot(unr_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     main = "Unrestricted",
     col = "red", pch = 16, type = "o", xaxt = "n", las = 2)
points(unr_fit[,2] ~ xm, xlim = range(xf, xm), col = "blue", pch = 16, type = "o")
segments(xf, unr_lwr[,1], xf, unr_upr[,1], col = "red")
segments(xm, unr_lwr[,2], xm, unr_upr[,2], col = "blue")
legend("bottomright", legend = c("Males", "Females"), pch = 16, col = c("Blue", "red"), lty = 1, pt.cex = 1.2, bg = "grey90", cex = 0.8)
axis(side = 1, at = 4:7, labels = 4:7)

par(mar = c(2,0.5,2,2))
plot(res_fit[,1] ~ xf, ylim = c(0,1), xlim = range(xf, xm),
     main = "Restricted",
     yaxt = "n", xaxt = "n", col = "red", pch = 16, type = "o")
points(res_fit[,2] ~ xm, xlim = range(xf, xm), col = "blue", pch = 16, type = "o")
segments(xf, res_lwr[,1], xf, res_upr[,1], col = "red")
segments(xm, res_lwr[,2], xm, res_upr[,2], col = "blue")

axis(side = 1, at = 4:7, labels = 4:7)

mtext(side = 1, line = 0, outer = T, "Age")
mtext(side = 2, line = 0.5, outer = T, "Selectivity")

```

## Posterior v. Prior 

The prior on each parameter was normal with mean equal to the estimates presented in Bromaghin (2006), and standard deviation equal to the standard error presented therein times 10. 

```{r}
par(mfrow = c(2,2), mar = c(2,2,2,2))
junk = sapply(c("Vlam", "Vsig", "Vtha", "Vtau"), function(x) {
  samps = filter_post(post, x, format = "matrix")
  dens = apply(samps, 2, density)
  plot(1,1, type = "n", main = x, xlab = "", ylab = "",
       ylim = c(0, max(dens[[1]]$y, dens[[2]]$y, dens[[3]]$y)),
       xlim = range(dens[[1]]$x, dens[[2]]$x, dens[[3]]$x))
  lines(dens[[1]]$y ~ dens[[1]]$x, col = "blue")
  lines(dens[[2]]$y ~ dens[[2]]$x, col = "red")
  lines(dens[[3]]$y ~ dens[[3]]$x, col = "red", lty = 2)
  if (x == "Vlam") {
    legend("topleft", legend = c("Prior", "Posterior", "Yukon"), lty = c(1,1,2), col = c("red", "blue", "red"))
  }
})
```

# Maturity Trends

```{r, fig.width = 8, fig.height = 4}
pi = native_format(summ_post(post, "mu_pi_mat")[3,])

layout(matrix(1:3, 1, 3), widths = c(1,1,0.2))
par(mar = c(2,2,2,2), oma = c(0,1,0,0), xaxs = "i", yaxs = "i",
    cex.axis = 1.4, cex.main = 1.4)
fill_col = c("grey50", "grey65", "grey80", "grey95")
by = 1969:2013
sex = c("Females", "Males")
for (s in 1:2) {
  plot(1,1, type = "n", xlim = range(by), ylim = c(0,1), main = sex[s], las = 1)
  for (a in (na-1):1) {
    if (a == 1) {
      lines(pi[,a,s] ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(pi[,a,s])), col = fill_col[a])
    } else {
      lines(rowSums(pi[,1:a,s]) ~ by)
      polygon(x = c(by, rev(by)), y = c(rep(0, ny), rev(rowSums(pi[,1:a,s]))), col = fill_col[a])
    }
  }
  box()
}

par(mar = c(0.25, 0.25, 0.25, 0.25))
plot.new()
legend("center", title = "Age", legend = rev(c(4:7)), pch = 22, pt.bg = rev(fill_col), bty = "n", cex = 2, pt.cex = 4)
```

# Sex Trends

Points are random beta deviates for each brood year. _Considering removing the random beta effects here._

```{r}
par(mar = c(4,5,1,1))
pi_f = summ_post(post, "mu_pi_f")
# p_f = summ_post(post, "p_f")
by = 1969:2013

plot(pi_f[3,] ~ by, type = "l", xlab = "Brood Year", ylab = "Proportion Female Recruits", las = 1, ylim = range(pi_f[4:5,]))
polygon(x = c(by, rev(by)), y = c(pi_f[4,], rev(pi_f[5,])), col = "grey80", border = NA)
lines(pi_f[4,] ~ by, col = "grey")
lines(pi_f[5,] ~ by, col = "grey")
lines(pi_f[3,] ~ by, col = "black", lwd = 2)
# points(p_f[3,] ~ by)

```

```{r}
t(as.data.frame(summ(filter_post(post, "b1_sex", format = "matrix"), rnd = 4))) %>%
  kable(caption = "Posterior summary of the slope of this relationship (a logit-linear model)", row.names = F) %>%
  kable_styling(position = "center", full_width = F)
```

```{r}
t(as.data.frame(summ(exp(filter_post(post, "b1_sex", format = "matrix")), rnd = 4))) %>%
  kable(caption = "Posterior summary of the odds ratio multiplier ($e^{slope}$)", row.names = F, escape = F)%>%
  kable_styling(position = "center", full_width = F)
```

# Exploitation Rates

_These are total exploitation rates, with fishing mortality resulting from both subsistence and commercial._

## Year

```{r}
U_fit = summ_post(post, "Utot_t[")[3,]
U_lwr = summ_post(post, "Utot_t[")[4,]
U_upr = summ_post(post, "Utot_t[")[5,]

par(mar = c(2,5,2,2), cex.main = 1.4, cex.axis = 1.4, cex.lab = 1.4)
plot(U_fit ~ years, type = "n", ylim = c(0,1),las = 1,
     ylab = "Exploitation Rate")
polygon(x = c(years, rev(years)), y = c(U_lwr, rev(U_upr)),
        col = "grey80", border = NA)
lines(U_lwr ~ years, col = "grey")
lines(U_upr ~ years, col = "grey")
lines(U_fit ~ years, lwd = 2)
```

## Age/Year

```{r, fig.height = 8, fig.width = 6}
U_fit = native_format(summ_post(post, "Utot_ta[")[3,])
U_lwr = native_format(summ_post(post, "Utot_ta[")[4,])
U_upr = native_format(summ_post(post, "Utot_ta[")[5,])

par(mfcol = c(4,1), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
ages = a_min:a_max
for (a in 1:na) {
  plot(U_fit[,a] ~ years, type = "n",
       ylim = c(0,1),
       main = paste("Age", ages[a]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a], rev(U_upr[,a])),
          col = "grey80", border = NA)
  lines(U_lwr[,a] ~ years, col = "grey")
  lines(U_upr[,a] ~ years, col = "grey")
  lines(U_fit[,a] ~ years, lwd = 2)
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

## Age/Sex/Year

```{r, fig.height = 8, fig.width = 6}
U_fit = native_format(summ_post(post, "Utot_tas")[3,])
U_lwr = native_format(summ_post(post, "Utot_tas")[4,])
U_upr = native_format(summ_post(post, "Utot_tas")[5,])

par(mfcol = c(4,2), mar = c(2,2,2,2), oma = c(0,3,0,0), cex.main = 1.4, cex.axis = 1.4)
sexes = c("Females", "Males")
ages = a_min:a_max
for (s in 1:2) {
  for (a in 1:na) {
    plot(U_fit[,a,s] ~ years, type = "n",
         ylim = c(0,1),
         main = paste("Age", ages[a], sexes[s]), las = 1)
  polygon(x = c(years, rev(years)), y = c(U_lwr[,a,s], rev(U_upr[,a,s])), col = "grey80", border = NA)
  lines(U_lwr[,a,s] ~ years, col = "grey")
  lines(U_upr[,a,s] ~ years, col = "grey")
  lines(U_fit[,a,s] ~ years, lwd = 2)
  }
}

mtext(side = 2, outer = T, "Exploitation Rate", line = 1, cex = 1.2)
```

# Spawner-Recruit Relationship

```{r}
S = summ_post(post, "S_t[")
R = summ_post(post, "R[")
SRA_post = filter_post(post, c("alpha", "beta"), "matrix")

ricker = function(S, params) {
  params[1] * S * exp(-params[2] * S)
}

S_ind = 1:(nt - a_min)
R_ind = (a_max + 1):ny
by = 1976 + S_ind - 1
S_pred = seq(0, max(S[5,S_ind]), length = 100)

R_pred = t(apply(SRA_post, 1, function(x) ricker(S_pred, x)))
R_pred = apply(R_pred, 2, summ)

S = S/1000
R = R/1000
S_pred = S_pred/1000
R_pred = R_pred/1000

par(xaxs = "i", yaxs = "i", mar = c(5,5,1,1), cex.axis = 1.4, cex.lab = 1.4)
plot(R[3,R_ind] ~ S[3,S_ind], type = "n", las = 1,
     xlim = c(0, max(S[5,S_ind])) * 1.05,
     ylim = c(0, max(R[5,R_ind])) * 1.05,
     xlab = "Spawners (1000s)", ylab = "Recruits (1000s)")
polygon(x = c(S_pred, rev(S_pred)), y = c(R_pred[4,], rev(R_pred[5,])), 
        col = "grey90", border = NA)
lines(R_pred[4,] ~ S_pred, col = "grey")
lines(R_pred[5,] ~ S_pred, col = "grey")
lines(R_pred[3,] ~ S_pred)
# text(R[3,R_ind] ~ S[3,S_ind], 
#      labels = paste("'", substr(by, 3, 4), sep = ""), 
#      col = ifelse(by %in% 2011:2013, "red", "black"), font = 2)
segments(S[4,S_ind], R[3,R_ind], S[5,S_ind], R[3,R_ind], col = "grey")
segments(S[3,S_ind], R[4,R_ind], S[3,S_ind], R[5,R_ind], col = "grey")
points(R[3,R_ind] ~ S[3,S_ind], pch = 16)
abline(0,1, lty = 2)
```


```{r}
tab = t(summ_post(post, c("alpha", "beta", "sigma_R_white", "phi")))
tab["beta",] = tab["beta",] * 1e5
rownames(tab) = c("$\\alpha$", "$\\beta \\times 10^5$", "$\\sigma_R$", "$\\phi$")
kable(tab, digits = 2, escape = F) %>% 
  kable_styling(full_width = F)
```

`r if (model_code) "# JAGS Model Code"`

```{r, echo = model_code}
mod = function() {
  
  # Priors for SR portion
  log_alpha ~ dnorm(0,1.0E-2) %_% I(,6)
  beta ~ dunif(0,10)
  phi ~ dunif(-1, 0.99)                                      
  tau_R_white ~ dgamma(0.01, 0.01)        
  tau_R_red <- tau_R_white * (1 - phi * phi)
  log_resid_0 ~ dnorm(0, tau_R_red)#%_%T(-3,3)
  sigma_R_white <- 1 / sqrt(tau_R_white)
  sigma_R_red <- 1 / sqrt(tau_R_red)
  alpha <- exp(log_alpha)
  
  ### PART 1: BIOLOGICAL PROCESS SUBMODEL: BROOD YEAR RECRUITMENT PROCESS #####
  
  #1a) Brood year returns without SR link; drawn from a common lognormal dist
  log_mean_R0 ~ dnorm(0,1.0E-4)#%_%I(0,)        
  tau_R0 ~ dgamma(0.1,0.1)      
  sigma_R0 <- 1 / sqrt(tau_R0)
  for(y in 1:a_max){ 
    log_R[y] ~ dnorm(log_mean_R0, tau_R0)   
    R[y] <- exp(log_R[y])
    log_resid[y] <- log_R[y] - log_mean_R0
  }
  
  #1b) Stock-Recruitment with Autocorrelated lag-1 residuals: for years with spawner/recruit link
  for (y in (na+a_min):ny) {
    log_R[y] ~ dnorm(log_Rmean2[y],tau_R_white)
    R[y] <- exp(log_R[y])
    log_Rmean1[y] <- log_alpha + log(S_t[y-a_max]) - beta * S_t[y-a_max]
    log_resid[y] <- log_R[y] - log_Rmean1[y]
  }
  log_Rmean2[na+a_min] <- log_Rmean1[na+a_min] + phi * log_resid_0
  for (y in (na+a_min+1):ny) {
    log_Rmean2[y] <- log_Rmean1[y] + phi * log_resid[y-1]
  }
  
  ### PART 2: MATURITY PROCESS SUBMODEL ###
  # 2a) brood-year specific sex ratio
  sex_scale ~ dunif(0.01,1)
  sex_sum <- 1/sex_scale^2
  b0_sex ~ dnorm(0,1e-6)
  b1_sex ~ dnorm(0,1e-6)
  for (y in 1:ny) {
    logit(mu_pi_f[y]) <- b0_sex + b1_sex * y
    B1[y] <- mu_pi_f[y] * sex_sum
    B2[y] <- (1 - mu_pi_f[y]) * sex_sum
    p_f[y] ~ dbeta(B1[y], B2[y])
    R_sex[y,1] <- R[y] * p_f[y]
    R_sex[y,2] <- R[y] * (1 - p_f[y])
  }
  
  # 2b) brood year-specific maturity schedules by sex, with separate estimated time trends for each sex
  for (s in 1:2) {
    D_scale[s] ~ dunif(0.01,1)
    D_sum[s] <- 1/D_scale[s]^2
    
    # set coefs for last age
    b0_mat[s,na] <- 1
    b1_mat[s,na] <- 0
    
    # estimate coefficients for the rest of the ages
    for (a in 1:(na-1)) {
      b0_mat[s,a] ~ dnorm(0,0.0001)
      b1_mat[s,a] ~ dnorm(0,0.0001)
    }
    
    # draw dirichlet random variables around the expectation
    for (y in 1:ny) {
      for (a in 1:na) {
        eta_mat[y,a,s] <- exp(b0_mat[s,a] + b1_mat[s,a] * y)
        mu_pi_mat[y,a,s] <- eta_mat[y,a,s] / sum(eta_mat[y,1:na,s])
        gamma[y,a,s] <- D_sum[s] * mu_pi_mat[y,a,s]
        g[y,a,s] ~ dgamma(gamma[y,a,s],0.1)
        p[y,a,s] <- g[y,a,s]/sum(g[y,1:na,s])
      }
    }
  }
  
  ##### PART 3: HARVEST PROCESS MODEL #####
  # 3a) Apportion sex-specific recruits to each age and calendar year
  for (t in 1:nt) {
    for (a in 1:na) {
      for (s in 1:2) {
        N_tas[t,a,s] <- R_sex[t+na-a,s] * p[t+na-a,a,s]
      }
      N_ta[t,a] <- sum(N_tas[t,a,1:2])
    }
    N_t[t] <- sum(N_ta[t,1:na])
  }
  
  # 3b) Create age/sex/year/mesh-specific vulnerability/selectivity schedule

  Vtau ~ dnorm(1.920, 1/(0.012 * 10)^2)
  Vsig ~ dnorm(0.204, 1/(0.021 * 10)^2) %_% I(0,)
  Vtha ~ dnorm(0.622, 1/(0.033 * 10)^2) %_% I(0,)
  Vlam ~ dnorm(-0.547, 1/(0.075 * 10)^2)
  Vtau_prior ~ dnorm(1.920, 1/(0.012 * 10)^2)
  Vsig_prior ~ dnorm(0.204, 1/(0.021 * 10)^2) %_% I(0,)
  Vtha_prior ~ dnorm(0.622, 1/(0.033 * 10)^2) %_% I(0,)
  Vlam_prior ~ dnorm(-0.547, 1/(0.075 * 10)^2)
  
  for (t in 1:nt) {
    for (s in 1:2) {
      for (m in 1:2) {
        for (a in 1:na) {
          # the pearson model
          v_term_1[t,a,s,m] <- (1 + Vlam^2/(4 * Vtha^2))^Vtha
          v_term_2[t,a,s,m] <- rlm[t,a,s,m] - (Vsig * Vlam)/(2 * Vtha) - Vtau
          v_term_3[t,a,s,m] <- (1 + v_term_2[t,a,s,m]^2/Vsig^2)^-Vtha
          v_term_4[t,a,s,m] <- exp(-Vlam * (atan(v_term_2[t,a,s,m]/Vsig) + atan(Vlam/(2 * Vtha))))
          v_raw[t,a,s,m] <- v_term_1[t,a,s,m] * v_term_3[t,a,s,m] * v_term_4[t,a,s,m]
          
          # standardize within year and mesh so one age/sex combo is fully vuln
          v[t,a,s,m] <- v_raw[t,a,s,m]/max(v_raw[t,1:na,1:2,m])
        }
      }
    }
  }
  
  # 3c: calculate harvest by age, sex, year, and fishery
  for (t in 1:nt) {
    Fsub[t] ~ dunif(0,10)
    Fcom[t] ~ dunif(0,10)
    for (a in 1:na) {
      for (s in 1:2) {
        Usub_tas[t,a,s] <- 1 - exp(-Fsub[t] * v[t,a,s,sub_mesh[t]])
        Ucom_tas[t,a,s] <- 1 - exp(-Fcom[t] * v[t,a,s,com_mesh[t]])
        
        Hsub_tas[t,a,s] <- N_tas[t,a,s] * Usub_tas[t,a,s]
        Hcom_tas[t,a,s] <- (N_tas[t,a,s] * (1 - Usub_tas[t,a,s])) * Ucom_tas[t,a,s]
        S_tas[t,a,s] <- N_tas[t,a,s] - Hsub_tas[t,a,s] - Hcom_tas[t,a,s]
        Utot_tas[t,a,s] <- (N_tas[t,a,s] - S_tas[t,a,s])/N_tas[t,a,s]
      }
      Hsub_ta[t,a] <- sum(Hsub_tas[t,a,1:2])
      Hcom_ta[t,a] <- sum(Hcom_tas[t,a,1:2])
      S_ta[t,a] <- sum(S_tas[t,a,1:2])
      Utot_ta[t,a] <- (N_ta[t,a] - S_ta[t,a])/N_ta[t,a]
    }
    Hsub[t] <- sum(Hsub_ta[t,1:na])
    Hcom[t] <- sum(Hcom_ta[t,1:na])
    S_t[t] <- sum(S_ta[t,1:na])
    Utot_t[t] <- (N_t[t] - S_t[t])/N_t[t]
    for (s in 1:2) {
      Utot_ts[t,s] <- (sum(N_tas[t,1:na,s]) - sum(S_tas[t,1:na,s]))/sum(N_tas[t,1:na,s])
    }
  }
  
  ### PART 4: OBSERVATION SUB MODEL ###
  for (t in 1:nt) {
    S_obs[t] ~ dlnorm(log(S_t[t]), 1/S_obs_sig[t]^2)
    Hcom_obs[t] ~ dlnorm(log(Hcom[t]), 1/Hcom_obs_sig[t]^2)
    Hsub_obs[t] ~ dlnorm(log(Hsub[t]), 1/Hsub_obs_sig[t]^2)
    
    # turn age/sex/year structured 3-d arrays into 2-d
      # [1:na] is females (s == 1); [(na+1):(2*na)] is males
      # allows fitting multinomial more easily
    
    N_tas_2d[t,1:na] <- N_tas[t,1:na,1]
    N_tas_2d[t,(na+1):(2*na)] <- N_tas[t,1:na,2]
    
    S_tas_2d[t,1:na] <- S_tas[t,1:na,1]
    S_tas_2d[t,(na+1):(2*na)] <- S_tas[t,1:na,2]
    
    Hcom_tas_2d[t,1:na] <- Hcom_tas[t,1:na,1]
    Hcom_tas_2d[t,(na+1):(2*na)] <- Hcom_tas[t,1:na,2]
    
    Hsub_tas_2d[t,1:na] <- Hsub_tas[t,1:na,1]
    Hsub_tas_2d[t,(na+1):(2*na)] <- Hsub_tas[t,1:na,2]
    
    for (as in 1:(na*2)) {
      q_esc[t,as] <- S_tas_2d[t,as]/S_t[t]
      q_com[t,as] <- Hcom_tas_2d[t,as]/Hcom[t]
      q_sub[t,as] <- Hsub_tas_2d[t,as]/Hsub[t]
      q_run[t,as] <- N_tas_2d[t,as]/N_t[t]
    }
    
    x_esc[t,1:(2*na)] ~ dmulti(q_esc[t,1:(2*na)], n_esc[t])
    x_com[t,1:(2*na)] ~ dmulti(q_com[t,1:(2*na)], n_com[t])
    x_sub[t,1:(2*na)] ~ dmulti(q_sub[t,1:(2*na)], n_sub[t])
  }
}

```

`r if (model_data) "# JAGS Data Inputs"`

```{r, eval = model_data}
jags_dat
```
